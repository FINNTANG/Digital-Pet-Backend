# Digital Pet Backend - LLMæœåŠ¡æ¶æ„è¯¦è§£

> ä¸ºæ–°æ‰‹å¼€å‘è€…å‡†å¤‡çš„å¤§æ¨¡å‹æœåŠ¡æ¶æ„å­¦ä¹ æ–‡æ¡£

---

## ğŸ“ æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯å±‚"
        A[å‰ç«¯åº”ç”¨] -->|HTTPè¯·æ±‚| B[Django Views]
    end
    
    subgraph "æœåŠ¡å±‚"
        B -->|è°ƒç”¨æœåŠ¡| C[LangChainLLMService]
        C -->|ç»§æ‰¿| D[SimpleLLMService]
    end
    
    subgraph "æ•°æ®å±‚"
        C -->|è¯»å†™| E[(ChatMessage)]
        C -->|è¯»å–| F[(LLMConfig)]
        C -->|å†…å­˜ç®¡ç†| G[å® ç‰©å±æ€§ç¼“å­˜]
    end
    
    subgraph "å¤–éƒ¨API"
        C -->|è°ƒç”¨| H[OpenAI API<br/>GPT-4o]
        C -->|Visionåˆ†æ| I[LLM Vision API<br/>å›¾ç‰‡å†…å®¹åˆ†æ]
    end
    
    style C fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff
    style D fill:#81C784,stroke:#388E3C,stroke-width:2px,color:#fff
    style H fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff
    style I fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff
```

---

## ğŸ—ï¸ ç±»ç»§æ‰¿å…³ç³»

```mermaid
classDiagram
    SimpleLLMService <|-- LangChainLLMService
    
    class SimpleLLMService {
        +user: User
        +config: LLMConfig
        +pet_attributes: dict
        +__init__(user)
        +_get_active_config() LLMConfig
        +get_chat_history(session_id, limit) List
        +save_message(role, content, session_id) ChatMessage
        +chat(user_message, session_id, pet_type, image_data) dict
        +_get_llm_response(user_message, session_id, pet_type, image_data) dict
        +_get_pet_attributes(session_id) dict
        +_update_pet_attributes(session_id, health_change, mood_change) dict
    }
    
    class LangChainLLMService {
        +_analyze_image_content(image_data) dict
        +_get_llm_response(user_message, session_id, pet_type, image_data) dict
        +_parse_json_response(content, session_id) dict
        +_get_system_prompt(pet_type) str
    }
```

---

## ğŸ”„ æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 1ï¸âƒ£ å®Œæ•´èŠå¤©æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant V as Django View
    participant S as LangChainLLMService
    participant DB as æ•°æ®åº“
    participant IMG as å›¾ç‰‡åˆ†ææ¨¡å—
    participant LLM as OpenAI API
    
    U->>V: å‘é€æ¶ˆæ¯ + å¯é€‰å›¾ç‰‡
    V->>S: chat(message, session_id, pet_type, image_data)
    
    S->>DB: save_message('user', message)
    
    alt æœ‰å›¾ç‰‡æ•°æ®
        S->>IMG: _analyze_image_content(image_data)
        IMG->>LLM: è°ƒç”¨Vision APIåˆ†æå›¾ç‰‡
        LLM-->>IMG: è¿”å›åˆ†æç»“æœ(äººè„¸/æƒ…ç»ª/ç‰©å“)
        IMG-->>S: è¿”å›å›¾ç‰‡åˆ†æç»“æœ
    end
    
    S->>DB: get_chat_history(session_id, limit=5)
    DB-->>S: è¿”å›å†å²æ¶ˆæ¯
    
    S->>S: _get_system_prompt(pet_type)
    Note over S: æ ¹æ®å® ç‰©ç±»å‹ç”Ÿæˆæç¤ºè¯
    
    S->>S: æ„å»ºæ¶ˆæ¯åˆ—è¡¨<br/>(ç³»ç»Ÿæç¤º+å†å²+æƒ…ç»ªä¸Šä¸‹æ–‡+å½“å‰æ¶ˆæ¯)
    
    S->>LLM: è°ƒç”¨ChatOpenAI.invoke(messages)
    LLM-->>S: è¿”å›AIå“åº”
    
    S->>S: _parse_json_response(content)
    Note over S: è§£æJSONæ ¼å¼<br/>æ›´æ–°å® ç‰©å±æ€§
    
    S->>DB: save_message('assistant', ai_response)
    
    S-->>V: è¿”å›å®Œæ•´JSONå“åº”
    V-->>U: è¿”å›å“åº”ç»™ç”¨æˆ·
```

---

### 2ï¸âƒ£ å›¾ç‰‡åˆ†ææµç¨‹ï¼ˆå¾®è¡¨æƒ…ä¸“å®¶æ¨¡å¼ï¼‰

```mermaid
flowchart TD
    A[æ¥æ”¶Base64å›¾ç‰‡æ•°æ®] --> B{æå–base64å†…å®¹}
    B --> C[åˆ›å»ºChatOpenAIå®ä¾‹]
    C --> D[æ„å»ºåˆ†ææç¤ºè¯<br/>æ‰®æ¼”å¾®è¡¨æƒ…ä¸“å®¶]
    
    D --> E[æ„å»ºHumanMessage<br/>æ–‡æœ¬æç¤º + å›¾ç‰‡URL]
    E --> F[è°ƒç”¨LLM.invoke]
    F --> G[LLMè¿”å›JSONå“åº”]
    
    G --> H[è§£æJSONå†…å®¹]
    H --> I{æ£€æµ‹åˆ°äººè„¸?}
    
    I -->|æ˜¯| J[æå–æƒ…ç»ªä¿¡æ¯<br/>detected_emotion<br/>emotion_confidence<br/>emotion_analysis]
    I -->|å¦| K[è®¾ç½®unknown]
    
    J --> L{æ£€æµ‹åˆ°ç‰©å“?}
    K --> L
    
    L -->|æ˜¯| M[æå–ç‰©å“æè¿°<br/>object_description]
    L -->|å¦| N[è®¾ç½®ç©ºæè¿°]
    
    M --> O[è¿”å›å®Œæ•´åˆ†æç»“æœ]
    N --> O
    
    style D fill:#FFE082,stroke:#F57C00
    style J fill:#81C784,stroke:#388E3C
    style M fill:#81C784,stroke:#388E3C
```

---

### 3ï¸âƒ£ JSONå“åº”è§£ææµç¨‹

```mermaid
flowchart TD
    A[æ¥æ”¶AIè¿”å›çš„content] --> B{æ˜¯å¦åŒ…å«```jsonæ ‡è®°?}
    
    B -->|æ˜¯| C[ä½¿ç”¨æ­£åˆ™æå–JSON<br/>```json\s*{...}\s*```]
    B -->|å¦| D{æ˜¯å¦åŒ…å«messageå­—æ®µ?}
    
    C --> E[json.loadsè§£æ]
    D -->|æ˜¯| F[ç›´æ¥æå–JSONå¯¹è±¡]
    D -->|å¦| G[å°†æ•´ä¸ªcontentä½œä¸ºJSON]
    
    F --> E
    G --> E
    
    E --> H{è§£ææˆåŠŸ?}
    
    H -->|æˆåŠŸ| I[æå–å¿…éœ€å­—æ®µ]
    H -->|å¤±è´¥| J[è¿”å›é»˜è®¤æ ¼å¼]
    
    I --> K[æ„å»ºæ ‡å‡†å“åº”å¯¹è±¡<br/>result, message, options,<br/>health, mood]
    
    K --> L[æ›´æ–°å® ç‰©å±æ€§ç¼“å­˜<br/>pet_attributes]
    
    J --> M[ä½¿ç”¨é»˜è®¤å€¼<br/>contentä½œä¸ºmessage]
    
    L --> N[è¿”å›æ ¼å¼åŒ–å“åº”]
    M --> N
    
    style I fill:#4CAF50,stroke:#2E7D32
    style K fill:#4CAF50,stroke:#2E7D32
    style J fill:#FF9800,stroke:#E65100
```

---

## ğŸ­ ä¸‰ç§å® ç‰©äººæ ¼ç³»ç»Ÿ

```mermaid
mindmap
  root((å® ç‰©äººæ ¼ç³»ç»Ÿ))
    Fox çµçµ
      æ ¸å¿ƒç‰¹è´¨
        èªæ˜
        å‚²å¨‡
        å¥½ç©
        å¥½å¥‡
      æ²»æ„ˆæ–¹å¼
        è®¤çŸ¥é‡æ„
        æ¸¸æˆåŒ–
        æ™ºæ…§é™ªä¼´
      é€‚ç”¨åœºæ™¯
        ç„¦è™‘
        å‹åŠ›
        å†…å·
    Dog å°é»˜
      æ ¸å¿ƒç‰¹è´¨
        æ¸©æš–
        å¿ è¯š
        æ¥çº³
        é™ªä¼´
      æ²»æ„ˆæ–¹å¼
        é•œåƒåé¦ˆ
        æ­£å‘å¼ºåŒ–
        æ­£å¿µå¼•å¯¼
      é€‚ç”¨åœºæ™¯
        å­¤ç‹¬
        ç–²æƒ«
        éœ€è¦æ”¯æŒ
    Snake é™
      æ ¸å¿ƒç‰¹è´¨
        å¹³é™
        è¶…è„±
        å“²å­¦
        æç®€
      æ²»æ„ˆæ–¹å¼
        é™çº§å¤„ç†
        è§‚å¯Ÿè€…è§†è§’
        èœ•çš®æ›´æ–°
      é€‚ç”¨åœºæ™¯
        æ··ä¹±
        ç„¦èº
        éœ€è¦å†·é™
```

---

## ğŸ“Š æ•°æ®æµè½¬å›¾

```mermaid
flowchart LR
    subgraph "è¾“å…¥æ•°æ®"
        A1[ç”¨æˆ·æ¶ˆæ¯]
        A2[ä¼šè¯ID]
        A3[å® ç‰©ç±»å‹]
        A4[å›¾ç‰‡æ•°æ®<br/>å¯é€‰]
    end
    
    subgraph "å¤„ç†å±‚"
        B1[ä¿å­˜ç”¨æˆ·æ¶ˆæ¯]
        B2[å›¾ç‰‡åˆ†æ]
        B3[è·å–å†å²]
        B4[ç”Ÿæˆæç¤ºè¯]
        B5[è°ƒç”¨LLM]
        B6[è§£æå“åº”]
        B7[æ›´æ–°å±æ€§]
    end
    
    subgraph "è¾“å‡ºæ•°æ®"
        C1[AIå›å¤æ¶ˆæ¯]
        C2[æ¨èé€‰é¡¹]
        C3[å® ç‰©å¥åº·å€¼]
        C4[å® ç‰©æƒ…ç»ªå€¼]
        C5[æ£€æµ‹åˆ°çš„æƒ…ç»ª<br/>å¯é€‰]
        C6[æ£€æµ‹åˆ°çš„ç‰©å“<br/>å¯é€‰]
    end
    
    A1 --> B1
    A2 --> B1 & B3
    A3 --> B4
    A4 --> B2
    
    B1 --> B3
    B2 --> B5
    B3 --> B5
    B4 --> B5
    B5 --> B6
    B6 --> B7
    
    B6 --> C1 & C2 & C3 & C4
    B2 --> C5 & C6
    
    style B2 fill:#FFE082,stroke:#F57C00
    style B5 fill:#4CAF50,stroke:#2E7D32
    style B6 fill:#81C784,stroke:#388E3C
```

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### ğŸ“¦ SimpleLLMServiceï¼ˆåŸºç¡€æœåŠ¡ç±»ï¼‰

```mermaid
graph TD
    A[SimpleLLMService] --> B[é…ç½®ç®¡ç†]
    A --> C[æ¶ˆæ¯ç®¡ç†]
    A --> D[å±æ€§ç®¡ç†]
    
    B --> B1[_get_active_config<br/>è·å–å¯ç”¨çš„é…ç½®]
    
    C --> C1[get_chat_history<br/>è·å–å†å²æ¶ˆæ¯]
    C --> C2[save_message<br/>ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“]
    
    D --> D1[_get_pet_attributes<br/>è·å–å® ç‰©å±æ€§]
    D --> D2[_update_pet_attributes<br/>æ›´æ–°å® ç‰©å±æ€§]
    
    A --> E[chatæ–¹æ³•<br/>ä¸»å…¥å£]
    E --> E1[1. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯]
    E --> E2[2. åˆå§‹åŒ–å® ç‰©å±æ€§]
    E --> E3[3. è°ƒç”¨_get_llm_response]
    E --> E4[4. ä¿å­˜AIå›å¤]
    E --> E5[5. è¿”å›å“åº”]
    
    style E fill:#2196F3,stroke:#0D47A1,color:#fff
```

---

### ğŸš€ LangChainLLMServiceï¼ˆå®Œæ•´ç‰ˆï¼‰

```mermaid
graph TD
    A[LangChainLLMService] --> B[å›¾ç‰‡åˆ†æèƒ½åŠ›]
    A --> C[çœŸå®LLMé›†æˆ]
    A --> D[äººæ ¼ç³»ç»Ÿ]
    
    B --> B1[_analyze_image_content<br/>LLM Visionåˆ†æ]
    B1 --> B1a[æ£€æµ‹äººè„¸]
    B1 --> B1b[åˆ†ææƒ…ç»ª<br/>å¾®è¡¨æƒ…ä¸“å®¶]
    B1 --> B1c[è¯†åˆ«ç‰©å“]
    
    C --> C1[_get_llm_response<br/>æ ¸å¿ƒé€»è¾‘]
    C1 --> C1a[åˆ›å»ºChatOpenAIå®ä¾‹]
    C1 --> C1b[æ„å»ºæ¶ˆæ¯åˆ—è¡¨]
    C1 --> C1c[è°ƒç”¨LLM API]
    C1 --> C1d[è§£æå“åº”]
    
    D --> D1[_get_system_prompt<br/>äººæ ¼æç¤ºè¯ç”Ÿæˆ]
    D1 --> D1a[Fox: æ™ºæ…§ç‹ç‹¸]
    D1 --> D1b[Dog: å¿ è¯šå°ç‹—]
    D1 --> D1c[Snake: å¹³é™è›‡]
    
    C1 --> E[_parse_json_response<br/>å“åº”è§£æå™¨]
    E --> E1[æå–JSON]
    E --> E2[éªŒè¯å­—æ®µ]
    E --> E3[æ›´æ–°å±æ€§]
    
    style B1 fill:#FFE082,stroke:#F57C00
    style C1 fill:#4CAF50,stroke:#2E7D32,color:#fff
    style D1 fill:#9C27B0,stroke:#4A148C,color:#fff
```

---

## ğŸ’¾ æ•°æ®æ¨¡å‹

```mermaid
erDiagram
    User ||--o{ ChatMessage : has
    User {
        int id PK
        string username
        string email
    }
    
    ChatMessage {
        int id PK
        int user_id FK
        string role
        text content
        string session_id
        datetime created_at
    }
    
    LLMConfig {
        int id PK
        string provider
        string model_name
        string api_key
        string api_base
        float temperature
        int max_tokens
        boolean is_active
    }
    
    PetAttributes {
        string session_id PK
        int health
        int mood
        note "å†…å­˜å­˜å‚¨ï¼Œéæ•°æ®åº“"
    }
```

---

## ğŸ¯ å…³é”®æŠ€æœ¯ç‚¹

### 1. å¤šæ¨¡æ€å¤„ç†ï¼ˆVision + Textï¼‰

```mermaid
sequenceDiagram
    participant C as å®¢æˆ·ç«¯
    participant S as Service
    participant V as Vision API
    participant T as Text LLM
    
    C->>S: å‘é€æ¶ˆæ¯ + å›¾ç‰‡
    
    rect rgb(255, 224, 130)
        Note over S,V: é˜¶æ®µ1: å›¾ç‰‡åˆ†æ
        S->>V: åˆ†æå›¾ç‰‡å†…å®¹
        V->>V: æ£€æµ‹äººè„¸
        V->>V: åˆ†æå¾®è¡¨æƒ…
        V->>V: è¯†åˆ«ç‰©å“
        V-->>S: è¿”å›åˆ†æç»“æœ
    end
    
    rect rgb(129, 199, 132)
        Note over S,T: é˜¶æ®µ2: æ–‡æœ¬å¯¹è¯
        S->>S: å°†å›¾ç‰‡åˆ†æç»“æœ<br/>èå…¥ä¸Šä¸‹æ–‡
        S->>T: å‘é€å®Œæ•´ä¸Šä¸‹æ–‡
        T-->>S: è¿”å›AIå›å¤
    end
    
    S-->>C: è¿”å›å“åº”<br/>(å«æƒ…ç»ª+ç‰©å“ä¿¡æ¯)
```

---

### 2. ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥

```mermaid
flowchart LR
    A[å½“å‰æ¶ˆæ¯] --> B[æ¶ˆæ¯åˆ—è¡¨]
    C[ç³»ç»Ÿæç¤ºè¯<br/>å® ç‰©äººæ ¼] --> B
    D[å†å²æ¶ˆæ¯<br/>æœ€è¿‘5æ¡] --> B
    E[æƒ…ç»ªä¸Šä¸‹æ–‡<br/>å¦‚æœæœ‰å›¾ç‰‡] --> B
    F[ç‰©å“æè¿°<br/>å¦‚æœè¯†åˆ«åˆ°] --> B
    
    B --> G[LLMå¤„ç†]
    G --> H[ç”Ÿæˆå“åº”]
    
    style C fill:#9C27B0,stroke:#4A148C,color:#fff
    style E fill:#FFE082,stroke:#F57C00
    style F fill:#FFE082,stroke:#F57C00
    style G fill:#4CAF50,stroke:#2E7D32,color:#fff
```

---

### 3. å±æ€§é©±åŠ¨çš„äº¤äº’ç³»ç»Ÿ

```mermaid
stateDiagram-v2
    [*] --> æ­£å¸¸çŠ¶æ€: åˆå§‹åŒ–
    
    æ­£å¸¸çŠ¶æ€ --> å¥åº·ä½ä¸‹: health < 30
    æ­£å¸¸çŠ¶æ€ --> æƒ…ç»ªä½è½: mood < 30
    æ­£å¸¸çŠ¶æ€ --> æ­£å¸¸çŠ¶æ€: å¸¸è§„äº¤äº’
    
    å¥åº·ä½ä¸‹ --> æ­£å¸¸çŠ¶æ€: ç”¨æˆ·è‡ªæˆ‘ç…§é¡¾<br/>(åƒé¥­/è¿åŠ¨/ç¡è§‰)
    æƒ…ç»ªä½è½ --> æ­£å¸¸çŠ¶æ€: è¶£å‘³äº’åŠ¨<br/>(æ¸¸æˆ/åˆ†äº«/é™ªä¼´)
    
    æ­£å¸¸çŠ¶æ€: health: 60-100
    æ­£å¸¸çŠ¶æ€: mood: 60-100
    æ­£å¸¸çŠ¶æ€: æä¾›å¸¸è§„é€‰é¡¹
    
    å¥åº·ä½ä¸‹: health: 0-29
    å¥åº·ä½ä¸‹: æç¤ºç¼ºä¹èƒ½é‡
    å¥åº·ä½ä¸‹: æ¨èè‡ªæˆ‘ç…§é¡¾
    
    æƒ…ç»ªä½è½: mood: 0-29
    æƒ…ç»ªä½è½: æ˜¾ç¤ºå­¤ç‹¬/æ— èŠ
    æƒ…ç»ªä½è½: é‚€è¯·è¶£å‘³äº’åŠ¨
```

---

## ğŸ“ JSONå“åº”æ ¼å¼æ ‡å‡†

```json
{
  "result": true,
  "message": "AIå›å¤æ¶ˆæ¯ï¼ˆå«åŠ¨ä½œæè¿°ï¼‰",
  "options": [
    "é€‰é¡¹1ï¼ˆâ‰¤5è¯ï¼‰",
    "é€‰é¡¹2ï¼ˆâ‰¤5è¯ï¼‰",
    "é€‰é¡¹3ï¼ˆâ‰¤5è¯ï¼‰"
  ],
  "health": 85,
  "mood": 90,
  "detected_emotion": "happy",
  "emotion_confidence": 0.95,
  "emotion_analysis": "å¾®è¡¨æƒ…åˆ†æç»“æœ",
  "detected_objects": "è¯†åˆ«åˆ°çš„ç‰©å“æè¿°"
}
```

---

## ğŸ›¡ï¸ éšç§ä¿æŠ¤è®¾è®¡

```mermaid
flowchart TD
    A[ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡] --> B{å›¾ç‰‡å¤„ç†}
    
    B --> C[Base64è§£ç ]
    C --> D[å†…å­˜ä¸­å¤„ç†]
    D --> E[å‘é€åˆ°LLM API]
    E --> F[è·å–åˆ†æç»“æœ]
    F --> G[æå–ç»“æ„åŒ–æ•°æ®]
    
    G --> H[è¿”å›ç»™å‰ç«¯]
    
    I[âŒ ä¸å†™å…¥æ•°æ®åº“] -.-> D
    J[âŒ ä¸ä¿å­˜åˆ°ç£ç›˜] -.-> D
    K[âŒ ä¸è®°å½•æ—¥å¿—] -.-> D
    L[âœ… ä»…å†…å­˜å¤„ç†] -.-> D
    M[âœ… ç”¨æˆ·æˆæƒ] -.-> A
    
    style I fill:#f44336,stroke:#c62828,color:#fff
    style J fill:#f44336,stroke:#c62828,color:#fff
    style K fill:#f44336,stroke:#c62828,color:#fff
    style L fill:#4CAF50,stroke:#2E7D32,color:#fff
    style M fill:#4CAF50,stroke:#2E7D32,color:#fff
```

---

## ğŸš€ å¿«é€Ÿä¸Šæ‰‹æŒ‡å—

### å¼€å‘è€…å­¦ä¹ è·¯å¾„

```mermaid
journey
    title æ–°æ‰‹å¼€å‘è€…å­¦ä¹ è·¯å¾„
    section ç¬¬1å¤©
      ç†è§£SimpleLLMServiceåŸºç¡€ç±»: 3: æ–°æ‰‹
      å­¦ä¹ chatæ–¹æ³•æµç¨‹: 4: æ–°æ‰‹
      äº†è§£æ•°æ®æ¨¡å‹: 3: æ–°æ‰‹
    section ç¬¬2å¤©
      æ·±å…¥LangChainLLMService: 5: æ–°æ‰‹
      ç†è§£å›¾ç‰‡åˆ†ææµç¨‹: 4: æ–°æ‰‹
      å­¦ä¹ JSONè§£ææœºåˆ¶: 4: æ–°æ‰‹
    section ç¬¬3å¤©
      ç ”ç©¶ä¸‰ç§å® ç‰©äººæ ¼ç³»ç»Ÿ: 5: æ–°æ‰‹
      ç†è§£å±æ€§é©±åŠ¨äº¤äº’: 5: æ–°æ‰‹
      å®è·µAPIè°ƒç”¨: 5: æ–°æ‰‹
    section ç¬¬4å¤©
      æŒæ¡ä¸Šä¸‹æ–‡ç®¡ç†: 5: è¿›é˜¶
      ä¼˜åŒ–æç¤ºè¯å·¥ç¨‹: 5: è¿›é˜¶
      å®Œæ•´åŠŸèƒ½æµ‹è¯•: 5: è¿›é˜¶
```

---

## ğŸ’¡ å…³é”®è®¾è®¡æ¨¡å¼

### 1. ç»§æ‰¿æ¨¡å¼
- **SimpleLLMService**: åŸºç¡€æ¡†æ¶ï¼Œæ˜“äºç†è§£
- **LangChainLLMService**: å®Œæ•´å®ç°ï¼Œç”Ÿäº§å°±ç»ª

### 2. ç­–ç•¥æ¨¡å¼
- æ ¹æ®`pet_type`åŠ¨æ€é€‰æ‹©äººæ ¼æç¤ºè¯
- ä¸‰ç§å® ç‰©å¯¹åº”ä¸‰ç§æ²»æ„ˆç­–ç•¥

### 3. æ¨¡æ¿æ–¹æ³•æ¨¡å¼
- `chat()`æ–¹æ³•å®šä¹‰éª¨æ¶æµç¨‹
- å­ç±»é‡å†™`_get_llm_response()`å®ç°ç»†èŠ‚

### 4. å·¥å‚æ¨¡å¼
- `_get_system_prompt()`æ ¹æ®ç±»å‹ç”Ÿæˆä¸åŒæç¤ºè¯

---

## ğŸ” è°ƒè¯•æŠ€å·§

```mermaid
flowchart TD
    A[é‡åˆ°é—®é¢˜] --> B{é—®é¢˜ç±»å‹}
    
    B -->|APIè°ƒç”¨å¤±è´¥| C[æ£€æŸ¥LLMConfigé…ç½®]
    C --> C1[éªŒè¯APIå¯†é’¥]
    C --> C2[æ£€æŸ¥ç½‘ç»œè¿æ¥]
    C --> C3[æŸ¥çœ‹é”™è¯¯æ—¥å¿—]
    
    B -->|JSONè§£æå¤±è´¥| D[æ£€æŸ¥LLMè¿”å›æ ¼å¼]
    D --> D1[æŸ¥çœ‹åŸå§‹å“åº”]
    D --> D2[éªŒè¯æ­£åˆ™è¡¨è¾¾å¼]
    D --> D3[æµ‹è¯•è§£æé€»è¾‘]
    
    B -->|å›¾ç‰‡åˆ†æå¤±è´¥| E[æ£€æŸ¥å›¾ç‰‡æ•°æ®]
    E --> E1[éªŒè¯Base64æ ¼å¼]
    E --> E2[æ£€æŸ¥å›¾ç‰‡å¤§å°]
    E --> E3[æµ‹è¯•Vision API]
    
    B -->|å±æ€§æœªæ›´æ–°| F[æ£€æŸ¥å±æ€§é€»è¾‘]
    F --> F1[éªŒè¯session_id]
    F --> F2[æ£€æŸ¥pet_attributesç¼“å­˜]
    F --> F3[æŸ¥çœ‹è§£æç»“æœ]
    
    style C1 fill:#FFE082
    style D1 fill:#FFE082
    style E1 fill:#FFE082
    style F1 fill:#FFE082
```

---

## ğŸ“š æ‰©å±•é˜…è¯»

1. **LangChainå®˜æ–¹æ–‡æ¡£**: https://python.langchain.com/
2. **OpenAI Vision API**: https://platform.openai.com/docs/guides/vision
3. **Prompt EngineeringæŒ‡å—**: æç¤ºè¯å·¥ç¨‹æœ€ä½³å®è·µ
4. **Django ORM**: æ•°æ®åº“æ“ä½œæ·±å…¥ç†è§£

---

## âœ… æ€»ç»“

è¿™ä¸ªLLMæœåŠ¡æ¶æ„çš„æ ¸å¿ƒä¼˜åŠ¿ï¼š

1. âœ¨ **æ¨¡å—åŒ–è®¾è®¡**: æ¸…æ™°çš„ç»§æ‰¿ç»“æ„ï¼Œæ˜“äºæ‰©å±•
2. ğŸ­ **å¤šäººæ ¼ç³»ç»Ÿ**: ä¸‰ç§å® ç‰©å¯¹åº”ä¸åŒæ²»æ„ˆåœºæ™¯
3. ğŸ‘ï¸ **å¤šæ¨¡æ€èƒ½åŠ›**: æ”¯æŒå›¾ç‰‡ + æ–‡æœ¬æ··åˆè¾“å…¥
4. ğŸ”’ **éšç§ä¼˜å…ˆ**: å›¾ç‰‡ä»…å†…å­˜å¤„ç†ï¼Œä¸æŒä¹…åŒ–
5. ğŸ“Š **å±æ€§é©±åŠ¨**: é€šè¿‡å¥åº·å€¼å’Œæƒ…ç»ªå€¼å¼•å¯¼ç”¨æˆ·è‡ªæˆ‘ç…§é¡¾
6. ğŸ¯ **é€‰é¡¹æ¨è**: æ™ºèƒ½ç”Ÿæˆ3ä¸ªå¿«é€Ÿé€‰é¡¹ï¼Œé™ä½ç”¨æˆ·å†³ç­–è´Ÿæ‹…

---

**ç¥å­¦ä¹ æ„‰å¿«ï¼ğŸ‰**
