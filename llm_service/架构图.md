# Digital Pet Backend - LLM服务架构详解

> 为新手开发者准备的大模型服务架构学习文档

---

## 📐 整体架构图

```mermaid
graph TB
    subgraph "客户端层"
        A[前端应用] -->|HTTP请求| B[Django Views]
    end
    
    subgraph "服务层"
        B -->|调用服务| C[LangChainLLMService]
        C -->|继承| D[SimpleLLMService]
    end
    
    subgraph "数据层"
        C -->|读写| E[(ChatMessage)]
        C -->|读取| F[(LLMConfig)]
        C -->|内存管理| G[宠物属性缓存]
    end
    
    subgraph "外部API"
        C -->|调用| H[OpenAI API<br/>GPT-4o]
        C -->|Vision分析| I[LLM Vision API<br/>图片内容分析]
    end
    
    style C fill:#4CAF50,stroke:#2E7D32,stroke-width:3px,color:#fff
    style D fill:#81C784,stroke:#388E3C,stroke-width:2px,color:#fff
    style H fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff
    style I fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff
```

---

## 🏗️ 类继承关系

```mermaid
classDiagram
    SimpleLLMService <|-- LangChainLLMService
    
    class SimpleLLMService {
        +user: User
        +config: LLMConfig
        +pet_attributes: dict
        +__init__(user)
        +_get_active_config() LLMConfig
        +get_chat_history(session_id, limit) List
        +save_message(role, content, session_id) ChatMessage
        +chat(user_message, session_id, pet_type, image_data) dict
        +_get_llm_response(user_message, session_id, pet_type, image_data) dict
        +_get_pet_attributes(session_id) dict
        +_update_pet_attributes(session_id, health_change, mood_change) dict
    }
    
    class LangChainLLMService {
        +_analyze_image_content(image_data) dict
        +_get_llm_response(user_message, session_id, pet_type, image_data) dict
        +_parse_json_response(content, session_id) dict
        +_get_system_prompt(pet_type) str
    }
```

---

## 🔄 核心业务流程

### 1️⃣ 完整聊天流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant V as Django View
    participant S as LangChainLLMService
    participant DB as 数据库
    participant IMG as 图片分析模块
    participant LLM as OpenAI API
    
    U->>V: 发送消息 + 可选图片
    V->>S: chat(message, session_id, pet_type, image_data)
    
    S->>DB: save_message('user', message)
    
    alt 有图片数据
        S->>IMG: _analyze_image_content(image_data)
        IMG->>LLM: 调用Vision API分析图片
        LLM-->>IMG: 返回分析结果(人脸/情绪/物品)
        IMG-->>S: 返回图片分析结果
    end
    
    S->>DB: get_chat_history(session_id, limit=5)
    DB-->>S: 返回历史消息
    
    S->>S: _get_system_prompt(pet_type)
    Note over S: 根据宠物类型生成提示词
    
    S->>S: 构建消息列表<br/>(系统提示+历史+情绪上下文+当前消息)
    
    S->>LLM: 调用ChatOpenAI.invoke(messages)
    LLM-->>S: 返回AI响应
    
    S->>S: _parse_json_response(content)
    Note over S: 解析JSON格式<br/>更新宠物属性
    
    S->>DB: save_message('assistant', ai_response)
    
    S-->>V: 返回完整JSON响应
    V-->>U: 返回响应给用户
```

---

### 2️⃣ 图片分析流程（微表情专家模式）

```mermaid
flowchart TD
    A[接收Base64图片数据] --> B{提取base64内容}
    B --> C[创建ChatOpenAI实例]
    C --> D[构建分析提示词<br/>扮演微表情专家]
    
    D --> E[构建HumanMessage<br/>文本提示 + 图片URL]
    E --> F[调用LLM.invoke]
    F --> G[LLM返回JSON响应]
    
    G --> H[解析JSON内容]
    H --> I{检测到人脸?}
    
    I -->|是| J[提取情绪信息<br/>detected_emotion<br/>emotion_confidence<br/>emotion_analysis]
    I -->|否| K[设置unknown]
    
    J --> L{检测到物品?}
    K --> L
    
    L -->|是| M[提取物品描述<br/>object_description]
    L -->|否| N[设置空描述]
    
    M --> O[返回完整分析结果]
    N --> O
    
    style D fill:#FFE082,stroke:#F57C00
    style J fill:#81C784,stroke:#388E3C
    style M fill:#81C784,stroke:#388E3C
```

---

### 3️⃣ JSON响应解析流程

```mermaid
flowchart TD
    A[接收AI返回的content] --> B{是否包含```json标记?}
    
    B -->|是| C[使用正则提取JSON<br/>```json\s*{...}\s*```]
    B -->|否| D{是否包含message字段?}
    
    C --> E[json.loads解析]
    D -->|是| F[直接提取JSON对象]
    D -->|否| G[将整个content作为JSON]
    
    F --> E
    G --> E
    
    E --> H{解析成功?}
    
    H -->|成功| I[提取必需字段]
    H -->|失败| J[返回默认格式]
    
    I --> K[构建标准响应对象<br/>result, message, options,<br/>health, mood]
    
    K --> L[更新宠物属性缓存<br/>pet_attributes]
    
    J --> M[使用默认值<br/>content作为message]
    
    L --> N[返回格式化响应]
    M --> N
    
    style I fill:#4CAF50,stroke:#2E7D32
    style K fill:#4CAF50,stroke:#2E7D32
    style J fill:#FF9800,stroke:#E65100
```

---

## 🎭 三种宠物人格系统

```mermaid
mindmap
  root((宠物人格系统))
    Fox 灵灵
      核心特质
        聪明
        傲娇
        好玩
        好奇
      治愈方式
        认知重构
        游戏化
        智慧陪伴
      适用场景
        焦虑
        压力
        内卷
    Dog 小默
      核心特质
        温暖
        忠诚
        接纳
        陪伴
      治愈方式
        镜像反馈
        正向强化
        正念引导
      适用场景
        孤独
        疲惫
        需要支持
    Snake 静
      核心特质
        平静
        超脱
        哲学
        极简
      治愈方式
        降级处理
        观察者视角
        蜕皮更新
      适用场景
        混乱
        焦躁
        需要冷静
```

---

## 📊 数据流转图

```mermaid
flowchart LR
    subgraph "输入数据"
        A1[用户消息]
        A2[会话ID]
        A3[宠物类型]
        A4[图片数据<br/>可选]
    end
    
    subgraph "处理层"
        B1[保存用户消息]
        B2[图片分析]
        B3[获取历史]
        B4[生成提示词]
        B5[调用LLM]
        B6[解析响应]
        B7[更新属性]
    end
    
    subgraph "输出数据"
        C1[AI回复消息]
        C2[推荐选项]
        C3[宠物健康值]
        C4[宠物情绪值]
        C5[检测到的情绪<br/>可选]
        C6[检测到的物品<br/>可选]
    end
    
    A1 --> B1
    A2 --> B1 & B3
    A3 --> B4
    A4 --> B2
    
    B1 --> B3
    B2 --> B5
    B3 --> B5
    B4 --> B5
    B5 --> B6
    B6 --> B7
    
    B6 --> C1 & C2 & C3 & C4
    B2 --> C5 & C6
    
    style B2 fill:#FFE082,stroke:#F57C00
    style B5 fill:#4CAF50,stroke:#2E7D32
    style B6 fill:#81C784,stroke:#388E3C
```

---

## 🔧 核心组件详解

### 📦 SimpleLLMService（基础服务类）

```mermaid
graph TD
    A[SimpleLLMService] --> B[配置管理]
    A --> C[消息管理]
    A --> D[属性管理]
    
    B --> B1[_get_active_config<br/>获取启用的配置]
    
    C --> C1[get_chat_history<br/>获取历史消息]
    C --> C2[save_message<br/>保存消息到数据库]
    
    D --> D1[_get_pet_attributes<br/>获取宠物属性]
    D --> D2[_update_pet_attributes<br/>更新宠物属性]
    
    A --> E[chat方法<br/>主入口]
    E --> E1[1. 保存用户消息]
    E --> E2[2. 初始化宠物属性]
    E --> E3[3. 调用_get_llm_response]
    E --> E4[4. 保存AI回复]
    E --> E5[5. 返回响应]
    
    style E fill:#2196F3,stroke:#0D47A1,color:#fff
```

---

### 🚀 LangChainLLMService（完整版）

```mermaid
graph TD
    A[LangChainLLMService] --> B[图片分析能力]
    A --> C[真实LLM集成]
    A --> D[人格系统]
    
    B --> B1[_analyze_image_content<br/>LLM Vision分析]
    B1 --> B1a[检测人脸]
    B1 --> B1b[分析情绪<br/>微表情专家]
    B1 --> B1c[识别物品]
    
    C --> C1[_get_llm_response<br/>核心逻辑]
    C1 --> C1a[创建ChatOpenAI实例]
    C1 --> C1b[构建消息列表]
    C1 --> C1c[调用LLM API]
    C1 --> C1d[解析响应]
    
    D --> D1[_get_system_prompt<br/>人格提示词生成]
    D1 --> D1a[Fox: 智慧狐狸]
    D1 --> D1b[Dog: 忠诚小狗]
    D1 --> D1c[Snake: 平静蛇]
    
    C1 --> E[_parse_json_response<br/>响应解析器]
    E --> E1[提取JSON]
    E --> E2[验证字段]
    E --> E3[更新属性]
    
    style B1 fill:#FFE082,stroke:#F57C00
    style C1 fill:#4CAF50,stroke:#2E7D32,color:#fff
    style D1 fill:#9C27B0,stroke:#4A148C,color:#fff
```

---

## 💾 数据模型

```mermaid
erDiagram
    User ||--o{ ChatMessage : has
    User {
        int id PK
        string username
        string email
    }
    
    ChatMessage {
        int id PK
        int user_id FK
        string role
        text content
        string session_id
        datetime created_at
    }
    
    LLMConfig {
        int id PK
        string provider
        string model_name
        string api_key
        string api_base
        float temperature
        int max_tokens
        boolean is_active
    }
    
    PetAttributes {
        string session_id PK
        int health
        int mood
        note "内存存储，非数据库"
    }
```

---

## 🎯 关键技术点

### 1. 多模态处理（Vision + Text）

```mermaid
sequenceDiagram
    participant C as 客户端
    participant S as Service
    participant V as Vision API
    participant T as Text LLM
    
    C->>S: 发送消息 + 图片
    
    rect rgb(255, 224, 130)
        Note over S,V: 阶段1: 图片分析
        S->>V: 分析图片内容
        V->>V: 检测人脸
        V->>V: 分析微表情
        V->>V: 识别物品
        V-->>S: 返回分析结果
    end
    
    rect rgb(129, 199, 132)
        Note over S,T: 阶段2: 文本对话
        S->>S: 将图片分析结果<br/>融入上下文
        S->>T: 发送完整上下文
        T-->>S: 返回AI回复
    end
    
    S-->>C: 返回响应<br/>(含情绪+物品信息)
```

---

### 2. 上下文管理策略

```mermaid
flowchart LR
    A[当前消息] --> B[消息列表]
    C[系统提示词<br/>宠物人格] --> B
    D[历史消息<br/>最近5条] --> B
    E[情绪上下文<br/>如果有图片] --> B
    F[物品描述<br/>如果识别到] --> B
    
    B --> G[LLM处理]
    G --> H[生成响应]
    
    style C fill:#9C27B0,stroke:#4A148C,color:#fff
    style E fill:#FFE082,stroke:#F57C00
    style F fill:#FFE082,stroke:#F57C00
    style G fill:#4CAF50,stroke:#2E7D32,color:#fff
```

---

### 3. 属性驱动的交互系统

```mermaid
stateDiagram-v2
    [*] --> 正常状态: 初始化
    
    正常状态 --> 健康低下: health < 30
    正常状态 --> 情绪低落: mood < 30
    正常状态 --> 正常状态: 常规交互
    
    健康低下 --> 正常状态: 用户自我照顾<br/>(吃饭/运动/睡觉)
    情绪低落 --> 正常状态: 趣味互动<br/>(游戏/分享/陪伴)
    
    正常状态: health: 60-100
    正常状态: mood: 60-100
    正常状态: 提供常规选项
    
    健康低下: health: 0-29
    健康低下: 提示缺乏能量
    健康低下: 推荐自我照顾
    
    情绪低落: mood: 0-29
    情绪低落: 显示孤独/无聊
    情绪低落: 邀请趣味互动
```

---

## 📝 JSON响应格式标准

```json
{
  "result": true,
  "message": "AI回复消息（含动作描述）",
  "options": [
    "选项1（≤5词）",
    "选项2（≤5词）",
    "选项3（≤5词）"
  ],
  "health": 85,
  "mood": 90,
  "detected_emotion": "happy",
  "emotion_confidence": 0.95,
  "emotion_analysis": "微表情分析结果",
  "detected_objects": "识别到的物品描述"
}
```

---

## 🛡️ 隐私保护设计

```mermaid
flowchart TD
    A[用户上传图片] --> B{图片处理}
    
    B --> C[Base64解码]
    C --> D[内存中处理]
    D --> E[发送到LLM API]
    E --> F[获取分析结果]
    F --> G[提取结构化数据]
    
    G --> H[返回给前端]
    
    I[❌ 不写入数据库] -.-> D
    J[❌ 不保存到磁盘] -.-> D
    K[❌ 不记录日志] -.-> D
    L[✅ 仅内存处理] -.-> D
    M[✅ 用户授权] -.-> A
    
    style I fill:#f44336,stroke:#c62828,color:#fff
    style J fill:#f44336,stroke:#c62828,color:#fff
    style K fill:#f44336,stroke:#c62828,color:#fff
    style L fill:#4CAF50,stroke:#2E7D32,color:#fff
    style M fill:#4CAF50,stroke:#2E7D32,color:#fff
```

---

## 🚀 快速上手指南

### 开发者学习路径

```mermaid
journey
    title 新手开发者学习路径
    section 第1天
      理解SimpleLLMService基础类: 3: 新手
      学习chat方法流程: 4: 新手
      了解数据模型: 3: 新手
    section 第2天
      深入LangChainLLMService: 5: 新手
      理解图片分析流程: 4: 新手
      学习JSON解析机制: 4: 新手
    section 第3天
      研究三种宠物人格系统: 5: 新手
      理解属性驱动交互: 5: 新手
      实践API调用: 5: 新手
    section 第4天
      掌握上下文管理: 5: 进阶
      优化提示词工程: 5: 进阶
      完整功能测试: 5: 进阶
```

---

## 💡 关键设计模式

### 1. 继承模式
- **SimpleLLMService**: 基础框架，易于理解
- **LangChainLLMService**: 完整实现，生产就绪

### 2. 策略模式
- 根据`pet_type`动态选择人格提示词
- 三种宠物对应三种治愈策略

### 3. 模板方法模式
- `chat()`方法定义骨架流程
- 子类重写`_get_llm_response()`实现细节

### 4. 工厂模式
- `_get_system_prompt()`根据类型生成不同提示词

---

## 🔍 调试技巧

```mermaid
flowchart TD
    A[遇到问题] --> B{问题类型}
    
    B -->|API调用失败| C[检查LLMConfig配置]
    C --> C1[验证API密钥]
    C --> C2[检查网络连接]
    C --> C3[查看错误日志]
    
    B -->|JSON解析失败| D[检查LLM返回格式]
    D --> D1[查看原始响应]
    D --> D2[验证正则表达式]
    D --> D3[测试解析逻辑]
    
    B -->|图片分析失败| E[检查图片数据]
    E --> E1[验证Base64格式]
    E --> E2[检查图片大小]
    E --> E3[测试Vision API]
    
    B -->|属性未更新| F[检查属性逻辑]
    F --> F1[验证session_id]
    F --> F2[检查pet_attributes缓存]
    F --> F3[查看解析结果]
    
    style C1 fill:#FFE082
    style D1 fill:#FFE082
    style E1 fill:#FFE082
    style F1 fill:#FFE082
```

---

## 📚 扩展阅读

1. **LangChain官方文档**: https://python.langchain.com/
2. **OpenAI Vision API**: https://platform.openai.com/docs/guides/vision
3. **Prompt Engineering指南**: 提示词工程最佳实践
4. **Django ORM**: 数据库操作深入理解

---

## ✅ 总结

这个LLM服务架构的核心优势：

1. ✨ **模块化设计**: 清晰的继承结构，易于扩展
2. 🎭 **多人格系统**: 三种宠物对应不同治愈场景
3. 👁️ **多模态能力**: 支持图片 + 文本混合输入
4. 🔒 **隐私优先**: 图片仅内存处理，不持久化
5. 📊 **属性驱动**: 通过健康值和情绪值引导用户自我照顾
6. 🎯 **选项推荐**: 智能生成3个快速选项，降低用户决策负担

---

**祝学习愉快！🎉**
