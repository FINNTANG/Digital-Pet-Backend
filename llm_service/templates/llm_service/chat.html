{% extends 'accounts/base.html' %}

{% block title %}AI聊天{% endblock %}

{% block content %}
<style>
    .pet-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .pet-btn:active {
        transform: translateY(0);
    }
    
    .pet-btn.active {
        border: 2px solid #3498db !important;
        background-color: #e3f2fd !important;
    }
</style>
<h1>AI聊天助手</h1>

<div style="margin-top: 1rem; display: flex; gap: 1rem;">
    <a href="{% url 'new_session' %}" class="btn btn-secondary">新建会话</a>
    <a href="{% url 'chat_history' %}" class="btn btn-secondary">查看历史</a>
    <button onclick="clearHistory()" class="btn btn-secondary">清空当前会话</button>
</div>

<div id="chat-container" style="margin-top: 2rem; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
    <!-- 聊天消息区域 -->
    <div id="chat-messages" style="height: 500px; overflow-y: auto; padding: 1.5rem; background-color: #fafafa;">
        {% if chat_history %}
            {% for msg in chat_history %}
            <div class="chat-message {{ msg.role }}" style="margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: start; gap: 1rem;">
                    <div class="message-avatar" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; {% if msg.role == 'user' %}background-color: #3498db; color: white;{% else %}background-color: #2ecc71; color: white;{% endif %}">
                        {% if msg.role == 'user' %}👤{% else %}🤖{% endif %}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; margin-bottom: 0.5rem; color: #555;">
                            {% if msg.role == 'user' %}您{% else %}AI助手{% endif %}
                        </div>
                        <div class="message-content" style="background-color: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); white-space: pre-wrap;">{{ msg.content }}</div>
                        <div style="font-size: 0.75rem; color: #999; margin-top: 0.5rem;">
                            {{ msg.created_at|date:"Y-m-d H:i:s" }}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div style="text-align: center; color: #999; padding: 2rem;">
            <p>还没有消息，开始对话吧！</p>
        </div>
        {% endif %}
    </div>
    
    <!-- 输入区域 -->
    <div style="padding: 1rem; background-color: white; border-top: 1px solid #ddd;">
        <!-- 摄像头情绪分析区域 -->
        <div id="emotion-capture-section" style="margin-bottom: 1rem; padding: 1rem; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <div style="font-weight: bold; color: #555;">📷 情绪识别（可选）</div>
                <div style="font-size: 0.75rem; color: #999;">通过摄像头识别你的情绪，让AI更懂你</div>
            </div>
            
            <!-- 摄像头控制按钮 -->
            <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                <button type="button" id="cam-start-btn" class="btn btn-secondary" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                    🎥 开启摄像头
                </button>
                <button type="button" id="cam-capture-btn" class="btn btn-primary" style="font-size: 0.875rem; padding: 0.5rem 1rem;" disabled>
                    📸 拍照识别
                </button>
                <button type="button" id="cam-stop-btn" class="btn btn-secondary" style="font-size: 0.875rem; padding: 0.5rem 1rem;" disabled>
                    ⏹️ 关闭
                </button>
                <button type="button" id="cam-clear-btn" class="btn btn-secondary" style="font-size: 0.875rem; padding: 0.5rem 1rem;" disabled>
                    🗑️ 清除照片
                </button>
            </div>
            
            <!-- 摄像头预览与照片显示 -->
            <div style="display: flex; gap: 1rem; align-items: start;">
                <div style="position: relative;">
                    <video id="webcam-preview" autoplay playsinline style="width: 240px; height: 180px; border-radius: 8px; background-color: #000; display: none; object-fit: cover;"></video>
                    <canvas id="snapshot-canvas" style="display: none;"></canvas>
                </div>
                <div id="photo-preview-container" style="display: none;">
                    <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.25rem;">已拍摄照片：</div>
                    <img id="photo-preview" style="max-width: 120px; border-radius: 8px; border: 2px solid #3498db;"/>
                    <div id="emotion-result" style="margin-top: 0.5rem; font-size: 0.875rem; color: #2ecc71; font-weight: bold;"></div>
                </div>
            </div>
            
            <!-- 隐私提示 -->
            <div style="font-size: 0.7rem; color: #999; margin-top: 0.5rem;">
                ℹ️ 隐私保护：照片仅用于即时情绪分析，不会保存到服务器
            </div>
        </div>
        
        <!-- 宠物选择器 -->
        <div style="margin-bottom: 1rem;">
            <div style="font-weight: bold; margin-bottom: 0.5rem; color: #555;">选择你的AI宠物伙伴：</div>
            <div id="pet-selector" style="display: flex; gap: 0.5rem;">
                <button type="button" class="pet-btn" data-pet="fox" style="flex: 1; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; background-color: white; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                    <span style="font-size: 2rem;">🦊</span>
                    <span style="font-size: 0.875rem; font-weight: 500;">灵灵（狐狸）</span>
                    <span style="font-size: 0.75rem; color: #999;">机敏俏皮</span>
                </button>
                <button type="button" class="pet-btn" data-pet="dog" style="flex: 1; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; background-color: white; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                    <span style="font-size: 2rem;">🐕</span>
                    <span style="font-size: 0.875rem; font-weight: 500;">小默（狗狗）</span>
                    <span style="font-size: 0.75rem; color: #999;">温暖陪伴</span>
                </button>
                <button type="button" class="pet-btn" data-pet="snake" style="flex: 1; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; background-color: white; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                    <span style="font-size: 2rem;">🐍</span>
                    <span style="font-size: 0.875rem; font-weight: 500;">静（蛇蛇）</span>
                    <span style="font-size: 0.75rem; color: #999;">冷静哲思</span>
                </button>
                <button type="button" class="pet-btn active" data-pet="none" style="flex: 1; padding: 0.75rem; border: 2px solid #3498db; border-radius: 8px; background-color: #e3f2fd; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                    <span style="font-size: 2rem;">🤖</span>
                    <span style="font-size: 0.875rem; font-weight: 500;">默认助手</span>
                    <span style="font-size: 0.75rem; color: #999;">标准模式</span>
                </button>
            </div>
        </div>
        
        <form id="chat-form" style="display: flex; gap: 1rem;">
            <input type="text" id="message-input" placeholder="输入您的消息..." style="flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" autofocus>
            <button type="submit" class="btn btn-primary" id="send-btn">发送</button>
        </form>
        <div id="loading-indicator" style="display: none; margin-top: 0.5rem; color: #3498db;">
            ⏳ AI正在思考...
        </div>
    </div>
</div>

<script>
// JavaScript代码：处理聊天交互

// 获取DOM元素
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const chatMessages = document.getElementById('chat-messages');
const loadingIndicator = document.getElementById('loading-indicator');
const sendBtn = document.getElementById('send-btn');

// 当前会话ID
const sessionId = '{{ session_id }}';

// 当前选择的宠物类型
let selectedPetType = 'none';

// ========== 摄像头情绪识别功能 ==========
let webcamStream = null;
let capturedImageData = null;

// 获取摄像头相关DOM元素
const camStartBtn = document.getElementById('cam-start-btn');
const camCaptureBtn = document.getElementById('cam-capture-btn');
const camStopBtn = document.getElementById('cam-stop-btn');
const camClearBtn = document.getElementById('cam-clear-btn');
const webcamPreview = document.getElementById('webcam-preview');
const snapshotCanvas = document.getElementById('snapshot-canvas');
const photoPreviewContainer = document.getElementById('photo-preview-container');
const photoPreview = document.getElementById('photo-preview');
const emotionResult = document.getElementById('emotion-result');

// 开启摄像头
camStartBtn.addEventListener('click', async () => {
    try {
        // 请求摄像头权限
        webcamStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: 'user'
            } 
        });
        
        webcamPreview.srcObject = webcamStream;
        webcamPreview.style.display = 'block';
        
        // 更新按钮状态
        camStartBtn.disabled = true;
        camCaptureBtn.disabled = false;
        camStopBtn.disabled = false;
        
    } catch (error) {
        console.error('摄像头访问失败:', error);
        alert('无法访问摄像头，请确保已授予权限并且设备支持摄像头。\n错误: ' + error.message);
    }
});

// 拍照并压缩
camCaptureBtn.addEventListener('click', () => {
    try {
        // 设置目标尺寸（压缩以减小数据量）
        const targetWidth = 320;
        const targetHeight = Math.round(webcamPreview.videoHeight * (targetWidth / webcamPreview.videoWidth));
        
        // 设置canvas尺寸
        snapshotCanvas.width = targetWidth;
        snapshotCanvas.height = targetHeight;
        
        // 绘制当前视频帧到canvas
        const ctx = snapshotCanvas.getContext('2d');
        ctx.drawImage(webcamPreview, 0, 0, targetWidth, targetHeight);
        
        // 转换为JPEG格式的Base64（质量0.7，进一步压缩）
        capturedImageData = snapshotCanvas.toDataURL('image/jpeg', 0.7);
        
        // 显示照片预览
        photoPreview.src = capturedImageData;
        photoPreviewContainer.style.display = 'block';
        emotionResult.textContent = '✅ 照片已捕获，将在发送消息时分析情绪';
        
        // 更新按钮状态
        camClearBtn.disabled = false;
        
        console.log('照片已捕获，数据大小:', (capturedImageData.length / 1024).toFixed(2), 'KB');
        
    } catch (error) {
        console.error('拍照失败:', error);
        alert('拍照失败: ' + error.message);
    }
});

// 关闭摄像头
camStopBtn.addEventListener('click', () => {
    if (webcamStream) {
        webcamStream.getTracks().forEach(track => track.stop());
        webcamStream = null;
    }
    
    webcamPreview.style.display = 'none';
    webcamPreview.srcObject = null;
    
    // 更新按钮状态
    camStartBtn.disabled = false;
    camCaptureBtn.disabled = true;
    camStopBtn.disabled = true;
});

// 清除已拍照片
camClearBtn.addEventListener('click', () => {
    capturedImageData = null;
    photoPreviewContainer.style.display = 'none';
    photoPreview.src = '';
    emotionResult.textContent = '';
    camClearBtn.disabled = true;
});

// 宠物选择器事件监听
const petButtons = document.querySelectorAll('.pet-btn');
petButtons.forEach(btn => {
    btn.addEventListener('click', () => {
        // 移除所有按钮的active类
        petButtons.forEach(b => {
            b.classList.remove('active');
            b.style.border = '2px solid #ddd';
            b.style.backgroundColor = 'white';
        });
        
        // 为当前按钮添加active类
        btn.classList.add('active');
        btn.style.border = '2px solid #3498db';
        btn.style.backgroundColor = '#e3f2fd';
        
        // 更新选择的宠物类型
        selectedPetType = btn.dataset.pet;
        
        // 更新输入框提示文本
        updatePlaceholder();
    });
});

// 更新输入框提示文本
function updatePlaceholder() {
    const placeholders = {
        'fox': '和聪明的小狐狸灵灵聊聊...',
        'dog': '和温暖的小狗小默说说话...',
        'snake': '和冷静的小蛇静交流...',
        'none': '输入您的消息...'
    };
    messageInput.placeholder = placeholders[selectedPetType] || '输入您的消息...';
}

// 表单提交事件
chatForm.addEventListener('submit', async (e) => {
    // 阻止表单默认提交行为
    e.preventDefault();
    
    // 获取用户输入的消息
    const message = messageInput.value.trim();
    if (!message) return;
    
    // 显示加载状态
    setLoading(true);
    
    // 添加用户消息到界面
    addMessage('user', message);
    
    // 清空输入框
    messageInput.value = '';
    
    try {
        // 构建请求体
        const requestBody = {
            message: message,
            session_id: sessionId
        };
        
        // 如果选择了宠物类型（且不是默认），添加到请求中
        if (selectedPetType !== 'none') {
            requestBody.pet_type = selectedPetType;
        }
        
        // 如果有捕获的照片，添加到请求中
        if (capturedImageData) {
            requestBody.image_data = capturedImageData;
            console.log('包含情绪识别照片');
        }
        
        // 发送消息到服务器
        const response = await fetch('{% url "send_message" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // 添加AI回复到界面
            addMessage('assistant', data.response);
            
            // 如果返回了情绪识别结果，显示在情绪结果区域
            if (data.data && data.data.detected_emotion) {
                const emotion = data.data.detected_emotion;
                const confidence = data.data.emotion_confidence || 0;
                const emotionEmojis = {
                    'happy': '😊', 'sad': '😢', 'angry': '😠',
                    'neutral': '😐', 'surprise': '😮', 'fear': '😨',
                    'disgust': '🤢', 'unknown': '❓'
                };
                const emoji = emotionEmojis[emotion] || '❓';
                emotionResult.textContent = `${emoji} 检测到情绪: ${emotion} (置信度: ${(confidence * 100).toFixed(0)}%)`;
                emotionResult.style.color = '#2ecc71';
            }
            
            // 清除已使用的照片（可选，如果希望每次都重新拍照）
            // capturedImageData = null;
            // photoPreviewContainer.style.display = 'none';
        } else {
            alert('发送失败：' + data.error);
        }
    } catch (error) {
        alert('网络错误：' + error.message);
    } finally {
        // 隐藏加载状态
        setLoading(false);
    }
});

// 设置加载状态
function setLoading(isLoading) {
    loadingIndicator.style.display = isLoading ? 'block' : 'none';
    sendBtn.disabled = isLoading;
    messageInput.disabled = isLoading;
}

// 添加消息到界面
function addMessage(role, content) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${role}`;
    messageDiv.style.marginBottom = '1.5rem';
    
    const isUser = role === 'user';
    
    // 根据宠物类型获取头像和名称
    let avatar, name, avatarColor;
    if (isUser) {
        avatar = '👤';
        name = '您';
        avatarColor = '#3498db';
    } else {
        // AI助手根据选择的宠物类型显示不同头像
        const petAvatars = {
            'fox': { emoji: '🦊', name: '灵灵（狐狸）', color: '#ff6b35' },
            'dog': { emoji: '🐕', name: '小默（狗狗）', color: '#f7931e' },
            'snake': { emoji: '🐍', name: '静（蛇）', color: '#4ecdc4' },
            'none': { emoji: '🤖', name: 'AI助手', color: '#2ecc71' }
        };
        
        const petInfo = petAvatars[selectedPetType] || petAvatars['none'];
        avatar = petInfo.emoji;
        name = petInfo.name;
        avatarColor = petInfo.color;
    }
    
    messageDiv.innerHTML = `
        <div style="display: flex; align-items: start; gap: 1rem;">
            <div class="message-avatar" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background-color: ${avatarColor}; color: white;">
                ${avatar}
            </div>
            <div style="flex: 1;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; color: #555;">
                    ${name}
                </div>
                <div class="message-content" style="background-color: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); white-space: pre-wrap;">${escapeHtml(content)}</div>
                <div style="font-size: 0.75rem; color: #999; margin-top: 0.5rem;">
                    刚刚
                </div>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    
    // 滚动到底部
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// HTML转义函数（防止XSS攻击）
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 获取Cookie（用于CSRF令牌）
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 清空历史
async function clearHistory() {
    if (!confirm('确定要清空当前会话的所有消息吗？')) {
        return;
    }
    
    try {
        const response = await fetch('{% url "clear_history" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                session_id: sessionId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // 刷新页面
            location.reload();
        } else {
            alert('清空失败：' + data.error);
        }
    } catch (error) {
        alert('网络错误：' + error.message);
    }
}

// 页面加载完成后，滚动到底部
window.addEventListener('load', () => {
    chatMessages.scrollTop = chatMessages.scrollHeight;
});
</script>
{% endblock %}



