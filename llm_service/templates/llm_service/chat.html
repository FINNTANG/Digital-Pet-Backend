{% extends 'accounts/base.html' %}

{% block title %}AIèŠå¤©{% endblock %}

{% block content %}
<style>
    .pet-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .pet-btn:active {
        transform: translateY(0);
    }
    
    .pet-btn.active {
        border: 2px solid #3498db !important;
        background-color: #e3f2fd !important;
    }

    /* ANALYSIS.EXE é£æ ¼å¼¹çª—æ ·å¼ */
    .analysis-modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 500px;
        max-width: 90vw;
        background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
        border: 3px solid #00ff41;
        border-radius: 0;
        box-shadow: 0 0 30px rgba(0, 255, 65, 0.5), 0 0 60px rgba(0, 255, 65, 0.3);
        font-family: 'Courier New', monospace;
        animation: glitchAnimation 0.3s ease-out;
    }

    @keyframes glitchAnimation {
        0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
        50% { transform: translate(-48%, -52%) scale(1.05); }
        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .analysis-overlay {
        display: none;
        position: fixed;
        z-index: 9998;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
    }

    .analysis-header {
        background: #00ff41;
        color: #000;
        padding: 8px 12px;
        font-weight: bold;
        font-size: 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        letter-spacing: 2px;
    }

    .analysis-close {
        cursor: pointer;
        font-size: 18px;
        color: #000;
        font-weight: bold;
        padding: 0 8px;
        transition: all 0.2s;
    }

    .analysis-close:hover {
        background: #000;
        color: #00ff41;
    }

    .analysis-body {
        padding: 20px;
        color: #00ff41;
        max-height: 70vh;
        overflow-y: auto;
    }

    .analysis-section {
        margin-bottom: 20px;
        border: 1px solid #00ff41;
        padding: 15px;
        background: rgba(0, 255, 65, 0.05);
    }

    .analysis-section-title {
        font-size: 12px;
        color: #00ff41;
        margin-bottom: 10px;
        font-weight: bold;
        letter-spacing: 1px;
    }

    .analysis-content {
        font-size: 14px;
        line-height: 1.6;
        color: #00ff41;
    }

    .analysis-image-preview {
        width: 100%;
        max-width: 100%;
        border: 2px solid #00ff41;
        margin-top: 10px;
        filter: contrast(1.1) brightness(0.95);
    }

    .emotion-display {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-top: 10px;
    }

    .emotion-emoji {
        font-size: 48px;
        filter: drop-shadow(0 0 10px rgba(0, 255, 65, 0.5));
    }

    .emotion-details {
        flex: 1;
    }

    .emotion-label {
        font-size: 18px;
        font-weight: bold;
        color: #00ff41;
        text-transform: uppercase;
    }

    .emotion-confidence {
        font-size: 12px;
        color: #00cc33;
        margin-top: 5px;
    }

    .emotion-analysis-text {
        font-size: 11px;
        color: #00ff88;
        margin-top: 8px;
        font-style: italic;
    }

    .status-bar {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .status-item {
        flex: 1;
        background: rgba(0, 255, 65, 0.1);
        border: 1px solid #00ff41;
        padding: 8px;
        text-align: center;
    }

    .status-label {
        font-size: 10px;
        color: #00cc33;
    }

    .status-value {
        font-size: 16px;
        font-weight: bold;
        color: #00ff41;
        margin-top: 3px;
    }

    .matrix-effect {
        animation: matrixGlow 2s ease-in-out infinite;
    }

    @keyframes matrixGlow {
        0%, 100% { text-shadow: 0 0 5px rgba(0, 255, 65, 0.5); }
        50% { text-shadow: 0 0 15px rgba(0, 255, 65, 1); }
    }

    .scanline {
        position: absolute;
        width: 100%;
        height: 2px;
        background: rgba(0, 255, 65, 0.3);
        animation: scan 4s linear infinite;
        pointer-events: none;
    }

    @keyframes scan {
        0% { top: 0; }
        100% { top: 100%; }
    }
</style>
<h1>AIèŠå¤©åŠ©æ‰‹</h1>

<!-- ANALYSIS.EXE å¼¹çª—é®ç½© -->
<div class="analysis-overlay" id="analysisOverlay" onclick="closeAnalysis()"></div>

<!-- ANALYSIS.EXE å¼¹çª— -->
<div class="analysis-modal" id="analysisModal">
    <div class="scanline"></div>
    <div class="analysis-header">
        <span class="matrix-effect">ANALYSIS.EXE</span>
        <span class="analysis-close" onclick="closeAnalysis()">âœ•</span>
    </div>
    <div class="analysis-body">
        <!-- ç…§ç‰‡é¢„è§ˆåŒº -->
        <div class="analysis-section">
            <div class="analysis-section-title">â–º IMAGE DATA</div>
            <div class="analysis-content">
                <img id="analysisImagePreview" class="analysis-image-preview" src="" alt="Captured Image">
            </div>
        </div>

        <!-- ç”¨æˆ·æƒ…ç»ªåˆ†æåŒº (ä»…åœ¨æ£€æµ‹åˆ°äººè„¸æ—¶æ˜¾ç¤º) -->
        <div class="analysis-section" id="emotionSection" style="display: none;">
            <div class="analysis-section-title">â–º USER EMOTION ANALYSIS</div>
            <div class="analysis-content">
                <div id="playerMoodContainer" style="display: none; margin-bottom: 12px; padding: 8px; background: rgba(0, 255, 65, 0.12); border: 1px solid rgba(0, 255, 65, 0.5);">
                    <span style="color: #00ff88; font-size: 13px;">Player Mood:</span>
                    <span id="playerMood" style="color: #00ff41; font-weight: bold; font-size: 15px; margin-left: 6px;">-</span>
                </div>
                <div class="emotion-display">
                    <div class="emotion-emoji" id="emotionEmoji">ğŸ˜</div>
                    <div class="emotion-details">
                        <div class="emotion-label" id="emotionLabel">NEUTRAL</div>
                        <div class="emotion-confidence">
                            Confidence: <span id="emotionConfidence" class="matrix-effect">0%</span>
                        </div>
                        <div class="emotion-analysis-text" id="emotionAnalysisText">
                            Analyzing facial microexpressions...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç‰©å“è¯†åˆ«åŒº (ä»…åœ¨æ£€æµ‹åˆ°ç‰©å“æ—¶æ˜¾ç¤º) -->
        <div class="analysis-section" id="objectSection" style="display: none;">
            <div class="analysis-content">
                <!-- Content ç‰©å“æè¿° -->
                <div style="margin-bottom: 12px;">
                    <span style="color: #00ff88; font-size: 13px;">Content: </span>
                    <span id="objectDescription" style="color: #fff; font-weight: normal; font-size: 14px; line-height: 1.5;">-</span>
                </div>
                
                <!-- Status å® ç‰©çŠ¶æ€ -->
                <div style="margin-bottom: 12px;">
                    <span style="color: #00ff88; font-size: 13px;">Status: </span>
                    <span id="petStatus" style="color: #ff4444; font-weight: bold; font-size: 14px;">-</span>
                </div>
                
                <!-- Effects æ•ˆæœ -->
                <div style="margin-top: 15px; border-top: 1px solid rgba(0, 255, 65, 0.3); padding-top: 12px;">
                    <div style="color: #00ff88; font-size: 12px; margin-bottom: 8px;">Effects:</div>
                    <div style="margin-left: 15px;">
                        <div style="margin-bottom: 5px;">
                            <span style="color: #00ff88; font-size: 13px;">Mood: </span>
                            <span id="moodEffect" class="matrix-effect" style="font-weight: bold; font-size: 15px;">+0</span>
                        </div>
                        <div>
                            <span style="color: #00ff88; font-size: 13px;">Health: </span>
                            <span id="healthEffect" class="matrix-effect" style="font-weight: bold; font-size: 15px;">+0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div style="margin-top: 1rem; display: flex; gap: 1rem;">
    <a href="{% url 'new_session' %}" class="btn btn-secondary">æ–°å»ºä¼šè¯</a>
    <a href="{% url 'chat_history' %}" class="btn btn-secondary">æŸ¥çœ‹å†å²</a>
    <button onclick="clearHistory()" class="btn btn-secondary">æ¸…ç©ºå½“å‰ä¼šè¯</button>
</div>

<div id="chat-container" style="margin-top: 2rem; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
    <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
    <div id="chat-messages" style="height: 500px; overflow-y: auto; padding: 1.5rem; background-color: #fafafa;">
        {% if chat_history %}
            {% for msg in chat_history %}
            <div class="chat-message {{ msg.role }}" style="margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: start; gap: 1rem;">
                    <div class="message-avatar" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; {% if msg.role == 'user' %}background-color: #3498db; color: white;{% else %}background-color: #2ecc71; color: white;{% endif %}">
                        {% if msg.role == 'user' %}ğŸ‘¤{% else %}ğŸ¤–{% endif %}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; margin-bottom: 0.5rem; color: #555;">
                            {% if msg.role == 'user' %}æ‚¨{% else %}AIåŠ©æ‰‹{% endif %}
                        </div>
                        <div class="message-content" style="background-color: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); white-space: pre-wrap;">{{ msg.content }}</div>
                        <div style="font-size: 0.75rem; color: #999; margin-top: 0.5rem;">
                            {{ msg.created_at|date:"Y-m-d H:i:s" }}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div style="text-align: center; color: #999; padding: 2rem;">
            <p>è¿˜æ²¡æœ‰æ¶ˆæ¯ï¼Œå¼€å§‹å¯¹è¯å§ï¼</p>
        </div>
        {% endif %}
    </div>
    
    <!-- è¾“å…¥åŒºåŸŸ -->
    <div style="padding: 1rem; background-color: white; border-top: 1px solid #ddd;">
        <!-- æ‘„åƒå¤´æƒ…ç»ªåˆ†æåŒºåŸŸ -->
        <div id="emotion-capture-section" style="margin-bottom: 1rem; padding: 1rem; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <div style="font-weight: bold; color: #555;">ğŸ“· æƒ…ç»ªè¯†åˆ«ï¼ˆå¯é€‰ï¼‰</div>
                <div style="font-size: 0.75rem; color: #999;">é€šè¿‡æ‘„åƒå¤´è¯†åˆ«ä½ çš„æƒ…ç»ªï¼Œè®©AIæ›´æ‡‚ä½ </div>
            </div>
            
            <!-- æ‘„åƒå¤´æ§åˆ¶æŒ‰é’® -->
            <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                <button type="button" id="cam-start-btn" class="btn btn-secondary" style="font-size: 0.875rem; padding: 0.5rem 1rem;">
                    ğŸ¥ å¼€å¯æ‘„åƒå¤´
                </button>
                <button type="button" id="cam-capture-btn" class="btn btn-primary" style="font-size: 0.875rem; padding: 0.5rem 1rem;" disabled>
                    ğŸ“¸ æ‹ç…§è¯†åˆ«
                </button>
                <button type="button" id="cam-stop-btn" class="btn btn-secondary" style="font-size: 0.875rem; padding: 0.5rem 1rem;" disabled>
                    â¹ï¸ å…³é—­
                </button>
                <button type="button" id="cam-clear-btn" class="btn btn-secondary" style="font-size: 0.875rem; padding: 0.5rem 1rem;" disabled>
                    ğŸ—‘ï¸ æ¸…é™¤ç…§ç‰‡
                </button>
            </div>
            
            <!-- æ‘„åƒå¤´é¢„è§ˆä¸ç…§ç‰‡æ˜¾ç¤º -->
            <div style="display: flex; gap: 1rem; align-items: start;">
                <div style="position: relative;">
                    <video id="webcam-preview" autoplay playsinline style="width: 240px; height: 180px; border-radius: 8px; background-color: #000; display: none; object-fit: cover;"></video>
                    <canvas id="snapshot-canvas" style="display: none;"></canvas>
                </div>
                <div id="photo-preview-container" style="display: none;">
                    <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.25rem;">å·²æ‹æ‘„ç…§ç‰‡ï¼š</div>
                    <img id="photo-preview" style="max-width: 120px; border-radius: 8px; border: 2px solid #3498db;"/>
                    <div id="emotion-result" style="margin-top: 0.5rem; font-size: 0.875rem; color: #2ecc71; font-weight: bold;"></div>
                </div>
            </div>
            
            <!-- éšç§æç¤º -->
            <div style="font-size: 0.7rem; color: #999; margin-top: 0.5rem;">
                â„¹ï¸ éšç§ä¿æŠ¤ï¼šç…§ç‰‡ä»…ç”¨äºå³æ—¶æƒ…ç»ªåˆ†æï¼Œä¸ä¼šä¿å­˜åˆ°æœåŠ¡å™¨
            </div>
        </div>
        
        <!-- å® ç‰©é€‰æ‹©å™¨ -->
        <div style="margin-bottom: 1rem;">
            <div style="font-weight: bold; margin-bottom: 0.5rem; color: #555;">é€‰æ‹©ä½ çš„AIå® ç‰©ä¼™ä¼´ï¼š</div>
            <div id="pet-selector" style="display: flex; gap: 0.5rem;">
                <button type="button" class="pet-btn" data-pet="fox" style="flex: 1; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; background-color: white; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                    <span style="font-size: 2rem;">ğŸ¦Š</span>
                    <span style="font-size: 0.875rem; font-weight: 500;">çµçµï¼ˆç‹ç‹¸ï¼‰</span>
                    <span style="font-size: 0.75rem; color: #999;">æœºæ•ä¿çš®</span>
                </button>
                <button type="button" class="pet-btn" data-pet="dog" style="flex: 1; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; background-color: white; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                    <span style="font-size: 2rem;">ğŸ•</span>
                    <span style="font-size: 0.875rem; font-weight: 500;">å°é»˜ï¼ˆç‹—ç‹—ï¼‰</span>
                    <span style="font-size: 0.75rem; color: #999;">æ¸©æš–é™ªä¼´</span>
                </button>
                <button type="button" class="pet-btn" data-pet="snake" style="flex: 1; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; background-color: white; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                    <span style="font-size: 2rem;">ğŸ</span>
                    <span style="font-size: 0.875rem; font-weight: 500;">é™ï¼ˆè›‡è›‡ï¼‰</span>
                    <span style="font-size: 0.75rem; color: #999;">å†·é™å“²æ€</span>
                </button>
                <button type="button" class="pet-btn active" data-pet="none" style="flex: 1; padding: 0.75rem; border: 2px solid #3498db; border-radius: 8px; background-color: #e3f2fd; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                    <span style="font-size: 2rem;">ğŸ¤–</span>
                    <span style="font-size: 0.875rem; font-weight: 500;">é»˜è®¤åŠ©æ‰‹</span>
                    <span style="font-size: 0.75rem; color: #999;">æ ‡å‡†æ¨¡å¼</span>
                </button>
            </div>
        </div>
        
        <form id="chat-form" style="display: flex; gap: 1rem;">
            <input type="text" id="message-input" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯..." style="flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" autofocus>
            <button type="submit" class="btn btn-primary" id="send-btn">å‘é€</button>
        </form>
        <div id="loading-indicator" style="display: none; margin-top: 0.5rem; color: #3498db;">
            â³ AIæ­£åœ¨æ€è€ƒ...
        </div>
    </div>
</div>

<script>
// JavaScriptä»£ç ï¼šå¤„ç†èŠå¤©äº¤äº’

// è·å–DOMå…ƒç´ 
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const chatMessages = document.getElementById('chat-messages');
const loadingIndicator = document.getElementById('loading-indicator');
const sendBtn = document.getElementById('send-btn');

// å½“å‰ä¼šè¯ID
const sessionId = '{{ session_id }}';

// å½“å‰é€‰æ‹©çš„å® ç‰©ç±»å‹
let selectedPetType = 'none';

// ========== æ‘„åƒå¤´æƒ…ç»ªè¯†åˆ«åŠŸèƒ½ ==========
let webcamStream = null;
let capturedImageData = null;

// è·å–æ‘„åƒå¤´ç›¸å…³DOMå…ƒç´ 
const camStartBtn = document.getElementById('cam-start-btn');
const camCaptureBtn = document.getElementById('cam-capture-btn');
const camStopBtn = document.getElementById('cam-stop-btn');
const camClearBtn = document.getElementById('cam-clear-btn');
const webcamPreview = document.getElementById('webcam-preview');
const snapshotCanvas = document.getElementById('snapshot-canvas');
const photoPreviewContainer = document.getElementById('photo-preview-container');
const photoPreview = document.getElementById('photo-preview');
const emotionResult = document.getElementById('emotion-result');

// å¼€å¯æ‘„åƒå¤´
camStartBtn.addEventListener('click', async () => {
    try {
        // è¯·æ±‚æ‘„åƒå¤´æƒé™
        webcamStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: 'user'
            } 
        });
        
        webcamPreview.srcObject = webcamStream;
        webcamPreview.style.display = 'block';
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        camStartBtn.disabled = true;
        camCaptureBtn.disabled = false;
        camStopBtn.disabled = false;
        
    } catch (error) {
        console.error('æ‘„åƒå¤´è®¿é—®å¤±è´¥:', error);
        alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿å·²æˆäºˆæƒé™å¹¶ä¸”è®¾å¤‡æ”¯æŒæ‘„åƒå¤´ã€‚\né”™è¯¯: ' + error.message);
    }
});

// æ‹ç…§å¹¶å‹ç¼©
camCaptureBtn.addEventListener('click', () => {
    try {
        // è®¾ç½®ç›®æ ‡å°ºå¯¸ï¼ˆå‹ç¼©ä»¥å‡å°æ•°æ®é‡ï¼‰
        const targetWidth = 320;
        const targetHeight = Math.round(webcamPreview.videoHeight * (targetWidth / webcamPreview.videoWidth));
        
        // è®¾ç½®canvaså°ºå¯¸
        snapshotCanvas.width = targetWidth;
        snapshotCanvas.height = targetHeight;
        
        // ç»˜åˆ¶å½“å‰è§†é¢‘å¸§åˆ°canvas
        const ctx = snapshotCanvas.getContext('2d');
        ctx.drawImage(webcamPreview, 0, 0, targetWidth, targetHeight);
        
        // è½¬æ¢ä¸ºJPEGæ ¼å¼çš„Base64ï¼ˆè´¨é‡0.7ï¼Œè¿›ä¸€æ­¥å‹ç¼©ï¼‰
        capturedImageData = snapshotCanvas.toDataURL('image/jpeg', 0.7);
        
        // æ˜¾ç¤ºç…§ç‰‡é¢„è§ˆ
        photoPreview.src = capturedImageData;
        photoPreviewContainer.style.display = 'block';
        emotionResult.textContent = 'âœ… ç…§ç‰‡å·²æ•è·ï¼Œå°†åœ¨å‘é€æ¶ˆæ¯æ—¶åˆ†ææƒ…ç»ª';
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        camClearBtn.disabled = false;
        
        console.log('ç…§ç‰‡å·²æ•è·ï¼Œæ•°æ®å¤§å°:', (capturedImageData.length / 1024).toFixed(2), 'KB');
        
    } catch (error) {
        console.error('æ‹ç…§å¤±è´¥:', error);
        alert('æ‹ç…§å¤±è´¥: ' + error.message);
    }
});

// å…³é—­æ‘„åƒå¤´
camStopBtn.addEventListener('click', () => {
    if (webcamStream) {
        webcamStream.getTracks().forEach(track => track.stop());
        webcamStream = null;
    }
    
    webcamPreview.style.display = 'none';
    webcamPreview.srcObject = null;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    camStartBtn.disabled = false;
    camCaptureBtn.disabled = true;
    camStopBtn.disabled = true;
});

// æ¸…é™¤å·²æ‹ç…§ç‰‡
camClearBtn.addEventListener('click', () => {
    capturedImageData = null;
    photoPreviewContainer.style.display = 'none';
    photoPreview.src = '';
    emotionResult.textContent = '';
    camClearBtn.disabled = true;
});

// å® ç‰©é€‰æ‹©å™¨äº‹ä»¶ç›‘å¬
const petButtons = document.querySelectorAll('.pet-btn');
petButtons.forEach(btn => {
    btn.addEventListener('click', () => {
        // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
        petButtons.forEach(b => {
            b.classList.remove('active');
            b.style.border = '2px solid #ddd';
            b.style.backgroundColor = 'white';
        });
        
        // ä¸ºå½“å‰æŒ‰é’®æ·»åŠ activeç±»
        btn.classList.add('active');
        btn.style.border = '2px solid #3498db';
        btn.style.backgroundColor = '#e3f2fd';
        
        // æ›´æ–°é€‰æ‹©çš„å® ç‰©ç±»å‹
        selectedPetType = btn.dataset.pet;
        
        // æ›´æ–°è¾“å…¥æ¡†æç¤ºæ–‡æœ¬
        updatePlaceholder();
    });
});

// æ›´æ–°è¾“å…¥æ¡†æç¤ºæ–‡æœ¬
function updatePlaceholder() {
    const placeholders = {
        'fox': 'å’Œèªæ˜çš„å°ç‹ç‹¸çµçµèŠèŠ...',
        'dog': 'å’Œæ¸©æš–çš„å°ç‹—å°é»˜è¯´è¯´è¯...',
        'snake': 'å’Œå†·é™çš„å°è›‡é™äº¤æµ...',
        'none': 'è¾“å…¥æ‚¨çš„æ¶ˆæ¯...'
    };
    messageInput.placeholder = placeholders[selectedPetType] || 'è¾“å…¥æ‚¨çš„æ¶ˆæ¯...';
}

// è¡¨å•æäº¤äº‹ä»¶
chatForm.addEventListener('submit', async (e) => {
    // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤è¡Œä¸º
    e.preventDefault();
    
    // è·å–ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯
    const message = messageInput.value.trim();
    if (!message) return;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    setLoading(true);
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
    addMessage('user', message);
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    messageInput.value = '';
    
    try {
        // æ„å»ºè¯·æ±‚ä½“
        const requestBody = {
            message: message,
            session_id: sessionId
        };
        
        // å¦‚æœé€‰æ‹©äº†å® ç‰©ç±»å‹ï¼ˆä¸”ä¸æ˜¯é»˜è®¤ï¼‰ï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
        if (selectedPetType !== 'none') {
            requestBody.pet_type = selectedPetType;
        }
        
        // å¦‚æœæœ‰æ•è·çš„ç…§ç‰‡ï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
        if (capturedImageData) {
            requestBody.image_data = capturedImageData;
            console.log('åŒ…å«æƒ…ç»ªè¯†åˆ«ç…§ç‰‡');
        }
        
        // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
        const response = await fetch('{% url "send_message" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // æ·»åŠ AIå›å¤åˆ°ç•Œé¢
            addMessage('assistant', data.response);
            
            // å¦‚æœå‘é€äº†å›¾ç‰‡ä¸”æœ‰åˆ†æç»“æœï¼Œæ˜¾ç¤ºANALYSIS.EXEå¼¹çª—
            if (capturedImageData && data.data) {
                showAnalysisWindow(capturedImageData, data.data);
            }
            
            // æ—§çš„æƒ…ç»ªç»“æœæ˜¾ç¤ºï¼ˆä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼‰
            if (data.data && data.data.detected_emotion && !capturedImageData) {
                const emotion = data.data.detected_emotion;
                const confidence = data.data.emotion_confidence || 0;
                const emotionEmojis = {
                    'happy': 'ğŸ˜Š', 'sad': 'ğŸ˜¢', 'angry': 'ğŸ˜ ',
                    'neutral': 'ğŸ˜', 'surprise': 'ğŸ˜®', 'fear': 'ğŸ˜¨',
                    'disgust': 'ğŸ¤¢', 'unknown': 'â“'
                };
                const emoji = emotionEmojis[emotion] || 'â“';
                emotionResult.textContent = `${emoji} æ£€æµ‹åˆ°æƒ…ç»ª: ${emotion} (ç½®ä¿¡åº¦: ${(confidence * 100).toFixed(0)}%)`;
                emotionResult.style.color = '#2ecc71';
            }
            
            // æ¸…é™¤å·²ä½¿ç”¨çš„ç…§ç‰‡ï¼ˆå¯é€‰ï¼Œå¦‚æœå¸Œæœ›æ¯æ¬¡éƒ½é‡æ–°æ‹ç…§ï¼‰
            // capturedImageData = null;
            // photoPreviewContainer.style.display = 'none';
        } else {
            alert('å‘é€å¤±è´¥ï¼š' + data.error);
        }
    } catch (error) {
        alert('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
    } finally {
        // éšè—åŠ è½½çŠ¶æ€
        setLoading(false);
    }
});

// è®¾ç½®åŠ è½½çŠ¶æ€
function setLoading(isLoading) {
    loadingIndicator.style.display = isLoading ? 'block' : 'none';
    sendBtn.disabled = isLoading;
    messageInput.disabled = isLoading;
}

// æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
function addMessage(role, content) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${role}`;
    messageDiv.style.marginBottom = '1.5rem';
    
    const isUser = role === 'user';
    
    // æ ¹æ®å® ç‰©ç±»å‹è·å–å¤´åƒå’Œåç§°
    let avatar, name, avatarColor;
    if (isUser) {
        avatar = 'ğŸ‘¤';
        name = 'æ‚¨';
        avatarColor = '#3498db';
    } else {
        // AIåŠ©æ‰‹æ ¹æ®é€‰æ‹©çš„å® ç‰©ç±»å‹æ˜¾ç¤ºä¸åŒå¤´åƒ
        const petAvatars = {
            'fox': { emoji: 'ğŸ¦Š', name: 'çµçµï¼ˆç‹ç‹¸ï¼‰', color: '#ff6b35' },
            'dog': { emoji: 'ğŸ•', name: 'å°é»˜ï¼ˆç‹—ç‹—ï¼‰', color: '#f7931e' },
            'snake': { emoji: 'ğŸ', name: 'é™ï¼ˆè›‡ï¼‰', color: '#4ecdc4' },
            'none': { emoji: 'ğŸ¤–', name: 'AIåŠ©æ‰‹', color: '#2ecc71' }
        };
        
        const petInfo = petAvatars[selectedPetType] || petAvatars['none'];
        avatar = petInfo.emoji;
        name = petInfo.name;
        avatarColor = petInfo.color;
    }
    
    messageDiv.innerHTML = `
        <div style="display: flex; align-items: start; gap: 1rem;">
            <div class="message-avatar" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background-color: ${avatarColor}; color: white;">
                ${avatar}
            </div>
            <div style="flex: 1;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; color: #555;">
                    ${name}
                </div>
                <div class="message-content" style="background-color: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); white-space: pre-wrap;">${escapeHtml(content)}</div>
                <div style="font-size: 0.75rem; color: #999; margin-top: 0.5rem;">
                    åˆšåˆš
                </div>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// HTMLè½¬ä¹‰å‡½æ•°ï¼ˆé˜²æ­¢XSSæ”»å‡»ï¼‰
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// è·å–Cookieï¼ˆç”¨äºCSRFä»¤ç‰Œï¼‰
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// æ¸…ç©ºå†å²
async function clearHistory() {
    if (!confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰ä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯å—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch('{% url "clear_history" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                session_id: sessionId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // åˆ·æ–°é¡µé¢
            location.reload();
        } else {
            alert('æ¸…ç©ºå¤±è´¥ï¼š' + data.error);
        }
    } catch (error) {
        alert('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
    }
}

// ANALYSIS.EXE å¼¹çª—æ§åˆ¶å‡½æ•°
function showAnalysisWindow(imageData, analysisData) {
    console.log('[ANALYSIS.EXE] æ˜¾ç¤ºåˆ†æçª—å£', analysisData);
    
    // è®¾ç½®å›¾ç‰‡é¢„è§ˆ
    document.getElementById('analysisImagePreview').src = imageData;
    
    // æƒ…ç»ªæ˜ å°„
    const emotionEmojis = {
        'happy': 'ğŸ˜Š',
        'sad': 'ğŸ˜¢',
        'angry': 'ğŸ˜ ',
        'neutral': 'ğŸ˜',
        'surprise': 'ğŸ˜®',
        'fear': 'ğŸ˜¨',
        'disgust': 'ğŸ¤¢',
        'unknown': 'â“'
    };
    
    const emotionLabelsUpper = {
        'happy': 'HAPPY',
        'sad': 'SAD',
        'angry': 'ANGRY',
        'neutral': 'NEUTRAL',
        'surprise': 'SURPRISE',
        'fear': 'FEAR',
        'disgust': 'DISGUST',
        'unknown': 'UNKNOWN'
    };

    const emotionLabelsShort = {
        'happy': 'Happy',
        'sad': 'Sad',
        'angry': 'Angry',
        'neutral': 'Neutral',
        'surprise': 'Surprised',
        'fear': 'Afraid',
        'disgust': 'Disgusted',
        'unknown': 'Unknown'
    };
    
    // å¤„ç†æƒ…ç»ªåˆ†æåŒºåŸŸ
    const emotionSection = document.getElementById('emotionSection');
    if (analysisData.detected_emotion && analysisData.detected_emotion !== 'unknown') {
        const emotion = analysisData.detected_emotion;
        const confidence = analysisData.emotion_confidence || 0;
        const analysis = analysisData.emotion_analysis || 'Facial expression detected.';
        
        document.getElementById('emotionEmoji').textContent = emotionEmojis[emotion] || 'â“';
        document.getElementById('emotionLabel').textContent = emotionLabelsUpper[emotion] || 'UNKNOWN';
        document.getElementById('emotionConfidence').textContent = `${(confidence * 100).toFixed(0)}%`;
        document.getElementById('emotionAnalysisText').textContent = analysis;
        document.getElementById('playerMood').textContent = emotionLabelsShort[emotion] || 'Unknown';
        document.getElementById('playerMoodContainer').style.display = 'block';
        
        emotionSection.style.display = 'block';
    } else {
        emotionSection.style.display = 'none';
        document.getElementById('playerMoodContainer').style.display = 'none';
    }
    
    // å¤„ç†ç‰©å“è¯†åˆ«åŒºåŸŸ
    const objectSection = document.getElementById('objectSection');
    if (analysisData.detected_objects) {
        // æ˜¾ç¤ºå®Œæ•´çš„ç‰©å“æè¿°ï¼ˆä» AI çš„å›å¤æ¶ˆæ¯ä¸­æå–æ›´è¯¦ç»†çš„æè¿°ï¼‰
        let fullDescription = analysisData.detected_objects;
        
        // å¦‚æœ AI å›å¤æ¶ˆæ¯åŒ…å«å¯¹ç‰©å“çš„è¯¦ç»†æè¿°ï¼Œä½¿ç”¨å®ƒ
        if (analysisData.message) {
            const msg = analysisData.message;
            // å°è¯•ä»æ¶ˆæ¯ä¸­æå–æ›´å®Œæ•´çš„ç‰©å“æè¿°ï¼ˆé€šå¸¸åœ¨ç¬¬ä¸€å¥è¯ï¼‰
            const sentences = msg.split(/[ã€‚ï¼ï¼Ÿ.!?]/);
            if (sentences.length > 0 && sentences[0].length > fullDescription.length) {
                fullDescription = sentences[0].trim();
            }
        }
        
        document.getElementById('objectDescription').textContent = fullDescription.slice(0, 45).trim();
        
        // æå–å® ç‰©çŠ¶æ€ï¼ˆä» AI å›å¤çš„ message ä¸­æå–æƒ…ç»ªè¡¨è¾¾ï¼‰
        let petStatusText = "Analyzing...";
        
        if (analysisData.message) {
            const msg = analysisData.message;
            
            // æ£€æµ‹å¸¸è§çš„æƒ…ç»ªè¡¨è¾¾æ¨¡å¼
            if (msg.includes('ä¸å–œæ¬¢') || msg.includes("don't like") || msg.includes("don't really") || msg.includes('è®¨åŒ')) {
                petStatusText = "I don't like it...";
            } else if (msg.includes('å–œæ¬¢') || msg.includes('love') || msg.includes('å¤ªå¥½äº†') || msg.includes('wonderful')) {
                petStatusText = "I love it!";
            } else if (msg.includes('æœ‰è¶£') || msg.includes('interesting') || msg.includes('å¥½å¥‡') || msg.includes('curious')) {
                petStatusText = "Interesting...";
            } else if (msg.includes('å¼€å¿ƒ') || msg.includes('happy') || msg.includes('excited')) {
                petStatusText = "That's nice!";
            } else if (msg.includes('æ— èŠ') || msg.includes('boring') || msg.includes('meh')) {
                petStatusText = "Meh...";
            } else if (msg.includes('å®³æ€•') || msg.includes('scary') || msg.includes('fear')) {
                petStatusText = "A bit scary...";
            } else {
                // å¦‚æœæ²¡æœ‰æ˜ç¡®çš„æƒ…ç»ªè¯ï¼Œæ ¹æ®æ£€æµ‹åˆ°çš„æƒ…ç»ªè®¾ç½®é»˜è®¤çŠ¶æ€
                if (analysisData.detected_emotion === 'happy') {
                    petStatusText = "Looks good!";
                } else if (analysisData.detected_emotion === 'sad') {
                    petStatusText = "Feeling down?";
                } else if (analysisData.detected_emotion === 'angry') {
                    petStatusText = "Not happy about this...";
                } else {
                    petStatusText = "I see it.";
                }
            }
        }
        
        document.getElementById('petStatus').textContent = petStatusText;
        objectSection.style.display = 'block';
    } else {
        objectSection.style.display = 'none';
    }
    
    // å¤„ç†æ•ˆæœçŠ¶æ€ - æ ¹æ®å®é™…çš„ mood å’Œ health å€¼è®¡ç®—å˜åŒ–
    let moodChange = 0;
    let healthChange = 0;
    
    // ä¼˜å…ˆä½¿ç”¨è¿”å›çš„ mood å’Œ health å€¼è®¡ç®—å˜åŒ–
    if (analysisData.mood !== undefined) {
        // å‡è®¾åˆå§‹å€¼æ˜¯æŸä¸ªåŸºå‡†ï¼ˆæ¯”å¦‚ä¹‹å‰çš„å€¼ï¼‰ï¼Œè®¡ç®—å·®å€¼
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼šæ ¹æ®æƒ…ç»ªå’Œç‰©å“æ¥ä¼°ç®—å˜åŒ–
        const baseMood = 80; // å‡è®¾çš„åŸºå‡†å€¼
        moodChange = analysisData.mood - baseMood;
    } else {
        // å¦‚æœæ²¡æœ‰è¿”å›å…·ä½“å€¼ï¼Œæ ¹æ®æƒ…ç»ªå’Œç‰©å“æ¨æµ‹
        if (analysisData.detected_emotion && analysisData.detected_emotion !== 'unknown') {
            const emotion = analysisData.detected_emotion;
            if (emotion === 'happy') {
                moodChange = +5;
            } else if (emotion === 'sad') {
                moodChange = -6;
            } else if (emotion === 'angry') {
                moodChange = -10;
            } else if (emotion === 'fear') {
                moodChange = -8;
            } else if (emotion === 'disgust') {
                moodChange = -6;
            } else if (emotion === 'surprise') {
                moodChange = +2;
            }
        }
    }
    
    if (analysisData.health !== undefined) {
        const baseHealth = 80;
        healthChange = analysisData.health - baseHealth;
    } else {
        // æ ¹æ®ç‰©å“ç±»å‹æ¨æµ‹å¥åº·å½±å“
        if (analysisData.detected_objects) {
            const objDesc = analysisData.detected_objects.toLowerCase();
            if (objDesc.includes('ç©å¶') || objDesc.includes('plush') || objDesc.includes('toy') || objDesc.includes('sonic')) {
                healthChange = -13; // ç©å…·å¯èƒ½è®©å® ç‰©æ„Ÿåˆ°å¨èƒæˆ–ä¸å®‰
            } else if (objDesc.includes('é£Ÿç‰©') || objDesc.includes('food')) {
                healthChange = +10;
            } else if (objDesc.includes('ä¹¦') || objDesc.includes('book')) {
                healthChange = +5;
            } else {
                healthChange = -5;
            }
        }
    }
    
    // æ˜¾ç¤ºæ•ˆæœå€¼ï¼ˆå¸¦é¢œè‰²ï¼‰
    const moodElement = document.getElementById('moodEffect');
    const healthElement = document.getElementById('healthEffect');
    
    moodElement.textContent = moodChange >= 0 ? `+${moodChange}` : `${moodChange}`;
    moodElement.style.color = moodChange >= 0 ? '#00ff41' : '#ff4444';
    
    healthElement.textContent = healthChange >= 0 ? `+${healthChange}` : `${healthChange}`;
    healthElement.style.color = healthChange >= 0 ? '#00ff41' : '#ff4444';
    
    // æ˜¾ç¤ºå¼¹çª—
    document.getElementById('analysisOverlay').style.display = 'block';
    document.getElementById('analysisModal').style.display = 'block';
}

function closeAnalysis() {
    document.getElementById('analysisOverlay').style.display = 'none';
    document.getElementById('analysisModal').style.display = 'none';
}

// é¡µé¢åŠ è½½å®Œæˆåï¼Œæ»šåŠ¨åˆ°åº•éƒ¨
window.addEventListener('load', () => {
    chatMessages.scrollTop = chatMessages.scrollHeight;
});
</script>
{% endblock %}



