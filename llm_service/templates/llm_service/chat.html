{% extends 'accounts/base.html' %}

{% block title %}AIèŠå¤©{% endblock %}

{% block content %}
<style>
    .pet-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .pet-btn:active {
        transform: translateY(0);
    }
    
    .pet-btn.active {
        border: 2px solid #3498db !important;
        background-color: #e3f2fd !important;
    }
</style>
<h1>AIèŠå¤©åŠ©æ‰‹</h1>

<div style="margin-top: 1rem; display: flex; gap: 1rem;">
    <a href="{% url 'new_session' %}" class="btn btn-secondary">æ–°å»ºä¼šè¯</a>
    <a href="{% url 'chat_history' %}" class="btn btn-secondary">æŸ¥çœ‹å†å²</a>
    <button onclick="clearHistory()" class="btn btn-secondary">æ¸…ç©ºå½“å‰ä¼šè¯</button>
</div>

<div id="chat-container" style="margin-top: 2rem; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
    <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
    <div id="chat-messages" style="height: 500px; overflow-y: auto; padding: 1.5rem; background-color: #fafafa;">
        {% if chat_history %}
            {% for msg in chat_history %}
            <div class="chat-message {{ msg.role }}" style="margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: start; gap: 1rem;">
                    <div class="message-avatar" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; {% if msg.role == 'user' %}background-color: #3498db; color: white;{% else %}background-color: #2ecc71; color: white;{% endif %}">
                        {% if msg.role == 'user' %}ğŸ‘¤{% else %}ğŸ¤–{% endif %}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; margin-bottom: 0.5rem; color: #555;">
                            {% if msg.role == 'user' %}æ‚¨{% else %}AIåŠ©æ‰‹{% endif %}
                        </div>
                        <div class="message-content" style="background-color: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); white-space: pre-wrap;">{{ msg.content }}</div>
                        <div style="font-size: 0.75rem; color: #999; margin-top: 0.5rem;">
                            {{ msg.created_at|date:"Y-m-d H:i:s" }}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div style="text-align: center; color: #999; padding: 2rem;">
            <p>è¿˜æ²¡æœ‰æ¶ˆæ¯ï¼Œå¼€å§‹å¯¹è¯å§ï¼</p>
        </div>
        {% endif %}
    </div>
    
    <!-- è¾“å…¥åŒºåŸŸ -->
    <div style="padding: 1rem; background-color: white; border-top: 1px solid #ddd;">
        <!-- å® ç‰©é€‰æ‹©å™¨ -->
        <div style="margin-bottom: 1rem;">
            <div style="font-weight: bold; margin-bottom: 0.5rem; color: #555;">é€‰æ‹©ä½ çš„AIå® ç‰©ä¼™ä¼´ï¼š</div>
            <div id="pet-selector" style="display: flex; gap: 0.5rem;">
                <button type="button" class="pet-btn" data-pet="fox" style="flex: 1; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; background-color: white; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                    <span style="font-size: 2rem;">ğŸ¦Š</span>
                    <span style="font-size: 0.875rem; font-weight: 500;">çµçµï¼ˆç‹ç‹¸ï¼‰</span>
                    <span style="font-size: 0.75rem; color: #999;">æœºæ•ä¿çš®</span>
                </button>
                <button type="button" class="pet-btn" data-pet="dog" style="flex: 1; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; background-color: white; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                    <span style="font-size: 2rem;">ğŸ•</span>
                    <span style="font-size: 0.875rem; font-weight: 500;">å°é»˜ï¼ˆç‹—ç‹—ï¼‰</span>
                    <span style="font-size: 0.75rem; color: #999;">æ¸©æš–é™ªä¼´</span>
                </button>
                <button type="button" class="pet-btn" data-pet="snake" style="flex: 1; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; background-color: white; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                    <span style="font-size: 2rem;">ğŸ</span>
                    <span style="font-size: 0.875rem; font-weight: 500;">é™ï¼ˆè›‡è›‡ï¼‰</span>
                    <span style="font-size: 0.75rem; color: #999;">å†·é™å“²æ€</span>
                </button>
                <button type="button" class="pet-btn active" data-pet="none" style="flex: 1; padding: 0.75rem; border: 2px solid #3498db; border-radius: 8px; background-color: #e3f2fd; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                    <span style="font-size: 2rem;">ğŸ¤–</span>
                    <span style="font-size: 0.875rem; font-weight: 500;">é»˜è®¤åŠ©æ‰‹</span>
                    <span style="font-size: 0.75rem; color: #999;">æ ‡å‡†æ¨¡å¼</span>
                </button>
            </div>
        </div>
        
        <form id="chat-form" style="display: flex; gap: 1rem;">
            <input type="text" id="message-input" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯..." style="flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;" autofocus>
            <button type="submit" class="btn btn-primary" id="send-btn">å‘é€</button>
        </form>
        <div id="loading-indicator" style="display: none; margin-top: 0.5rem; color: #3498db;">
            â³ AIæ­£åœ¨æ€è€ƒ...
        </div>
    </div>
</div>

<script>
// JavaScriptä»£ç ï¼šå¤„ç†èŠå¤©äº¤äº’

// è·å–DOMå…ƒç´ 
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const chatMessages = document.getElementById('chat-messages');
const loadingIndicator = document.getElementById('loading-indicator');
const sendBtn = document.getElementById('send-btn');

// å½“å‰ä¼šè¯ID
const sessionId = '{{ session_id }}';

// å½“å‰é€‰æ‹©çš„å® ç‰©ç±»å‹
let selectedPetType = 'none';

// å® ç‰©é€‰æ‹©å™¨äº‹ä»¶ç›‘å¬
const petButtons = document.querySelectorAll('.pet-btn');
petButtons.forEach(btn => {
    btn.addEventListener('click', () => {
        // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
        petButtons.forEach(b => {
            b.classList.remove('active');
            b.style.border = '2px solid #ddd';
            b.style.backgroundColor = 'white';
        });
        
        // ä¸ºå½“å‰æŒ‰é’®æ·»åŠ activeç±»
        btn.classList.add('active');
        btn.style.border = '2px solid #3498db';
        btn.style.backgroundColor = '#e3f2fd';
        
        // æ›´æ–°é€‰æ‹©çš„å® ç‰©ç±»å‹
        selectedPetType = btn.dataset.pet;
        
        // æ›´æ–°è¾“å…¥æ¡†æç¤ºæ–‡æœ¬
        updatePlaceholder();
    });
});

// æ›´æ–°è¾“å…¥æ¡†æç¤ºæ–‡æœ¬
function updatePlaceholder() {
    const placeholders = {
        'fox': 'å’Œèªæ˜çš„å°ç‹ç‹¸çµçµèŠèŠ...',
        'dog': 'å’Œæ¸©æš–çš„å°ç‹—å°é»˜è¯´è¯´è¯...',
        'snake': 'å’Œå†·é™çš„å°è›‡é™äº¤æµ...',
        'none': 'è¾“å…¥æ‚¨çš„æ¶ˆæ¯...'
    };
    messageInput.placeholder = placeholders[selectedPetType] || 'è¾“å…¥æ‚¨çš„æ¶ˆæ¯...';
}

// è¡¨å•æäº¤äº‹ä»¶
chatForm.addEventListener('submit', async (e) => {
    // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤è¡Œä¸º
    e.preventDefault();
    
    // è·å–ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯
    const message = messageInput.value.trim();
    if (!message) return;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    setLoading(true);
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
    addMessage('user', message);
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    messageInput.value = '';
    
    try {
        // æ„å»ºè¯·æ±‚ä½“
        const requestBody = {
            message: message,
            session_id: sessionId
        };
        
        // å¦‚æœé€‰æ‹©äº†å® ç‰©ç±»å‹ï¼ˆä¸”ä¸æ˜¯é»˜è®¤ï¼‰ï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
        if (selectedPetType !== 'none') {
            requestBody.pet_type = selectedPetType;
        }
        
        // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
        const response = await fetch('{% url "send_message" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // æ·»åŠ AIå›å¤åˆ°ç•Œé¢
            addMessage('assistant', data.response);
        } else {
            alert('å‘é€å¤±è´¥ï¼š' + data.error);
        }
    } catch (error) {
        alert('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
    } finally {
        // éšè—åŠ è½½çŠ¶æ€
        setLoading(false);
    }
});

// è®¾ç½®åŠ è½½çŠ¶æ€
function setLoading(isLoading) {
    loadingIndicator.style.display = isLoading ? 'block' : 'none';
    sendBtn.disabled = isLoading;
    messageInput.disabled = isLoading;
}

// æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
function addMessage(role, content) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${role}`;
    messageDiv.style.marginBottom = '1.5rem';
    
    const isUser = role === 'user';
    
    // æ ¹æ®å® ç‰©ç±»å‹è·å–å¤´åƒå’Œåç§°
    let avatar, name, avatarColor;
    if (isUser) {
        avatar = 'ğŸ‘¤';
        name = 'æ‚¨';
        avatarColor = '#3498db';
    } else {
        // AIåŠ©æ‰‹æ ¹æ®é€‰æ‹©çš„å® ç‰©ç±»å‹æ˜¾ç¤ºä¸åŒå¤´åƒ
        const petAvatars = {
            'fox': { emoji: 'ğŸ¦Š', name: 'çµçµï¼ˆç‹ç‹¸ï¼‰', color: '#ff6b35' },
            'dog': { emoji: 'ğŸ•', name: 'å°é»˜ï¼ˆç‹—ç‹—ï¼‰', color: '#f7931e' },
            'snake': { emoji: 'ğŸ', name: 'é™ï¼ˆè›‡ï¼‰', color: '#4ecdc4' },
            'none': { emoji: 'ğŸ¤–', name: 'AIåŠ©æ‰‹', color: '#2ecc71' }
        };
        
        const petInfo = petAvatars[selectedPetType] || petAvatars['none'];
        avatar = petInfo.emoji;
        name = petInfo.name;
        avatarColor = petInfo.color;
    }
    
    messageDiv.innerHTML = `
        <div style="display: flex; align-items: start; gap: 1rem;">
            <div class="message-avatar" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; background-color: ${avatarColor}; color: white;">
                ${avatar}
            </div>
            <div style="flex: 1;">
                <div style="font-weight: bold; margin-bottom: 0.5rem; color: #555;">
                    ${name}
                </div>
                <div class="message-content" style="background-color: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); white-space: pre-wrap;">${escapeHtml(content)}</div>
                <div style="font-size: 0.75rem; color: #999; margin-top: 0.5rem;">
                    åˆšåˆš
                </div>
            </div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// HTMLè½¬ä¹‰å‡½æ•°ï¼ˆé˜²æ­¢XSSæ”»å‡»ï¼‰
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// è·å–Cookieï¼ˆç”¨äºCSRFä»¤ç‰Œï¼‰
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// æ¸…ç©ºå†å²
async function clearHistory() {
    if (!confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰ä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯å—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch('{% url "clear_history" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                session_id: sessionId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // åˆ·æ–°é¡µé¢
            location.reload();
        } else {
            alert('æ¸…ç©ºå¤±è´¥ï¼š' + data.error);
        }
    } catch (error) {
        alert('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
    }
}

// é¡µé¢åŠ è½½å®Œæˆåï¼Œæ»šåŠ¨åˆ°åº•éƒ¨
window.addEventListener('load', () => {
    chatMessages.scrollTop = chatMessages.scrollHeight;
});
</script>
{% endblock %}


