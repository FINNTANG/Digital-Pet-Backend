# Django LLM 项目架构与部署总览

## 📊 项目全景图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户访问层                               │
│  Web浏览器 / 移动端 / API客户端                                  │
└──────────────────────┬──────────────────────────────────────────┘
                       │ HTTPS (443)
                       ↓
┌─────────────────────────────────────────────────────────────────┐
│                      Nginx 反向代理                              │
│  • SSL/TLS 加密                                                  │
│  • 静态文件服务 (/static/, /media/)                             │
│  • 请求限流和安全过滤                                            │
│  • Gzip 压缩                                                     │
└──────────────────────┬──────────────────────────────────────────┘
                       │ HTTP (8000)
                       ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Gunicorn WSGI 服务器                          │
│  • 多进程工作模式                                                │
│  • 请求负载均衡                                                  │
│  • 进程守护和自动重启                                            │
└──────────────────────┬──────────────────────────────────────────┘
                       │
                       ↓
┌─────────────────────────────────────────────────────────────────┐
│                     Django 应用层                                │
│                                                                  │
│  ┌────────────────────────────────────────────────────┐         │
│  │         accounts (用户管理模块)                     │         │
│  │  • 用户注册/登录/登出                               │         │
│  │  • 个人中心管理                                     │         │
│  │  • REST API + JWT认证                               │         │
│  └────────────────────────────────────────────────────┘         │
│                                                                  │
│  ┌────────────────────────────────────────────────────┐         │
│  │        llm_service (AI聊天模块)                    │         │
│  │  • 多宠物人格系统 (狐狸/狗/蛇)                      │         │
│  │  • 情绪识别 (DeepFace + GPT-4o Vision)             │         │
│  │  • 聊天历史管理                                     │         │
│  │  • 支持游客访问                                     │         │
│  │  • REST API接口                                     │         │
│  └────────────────────────────────────────────────────┘         │
│                                                                  │
└──────────────────┬────────────────────┬──────────────────────────┘
                   │                    │
                   ↓                    ↓
┌──────────────────────────┐  ┌────────────────────────────┐
│      数据库层             │  │     外部API服务             │
│  SQLite / MySQL /        │  │  • OpenAI GPT-4o           │
│  PostgreSQL              │  │  • OpenRouter              │
│  • 用户数据               │  │  • DeepFace 模型           │
│  • 聊天记录               │  │                            │
│  • LLM配置                │  │                            │
└──────────────────────────┘  └────────────────────────────┘
```

---

## 🏗️ 技术架构详解

### 1. 前端层
**技术栈**：
- Django Templates（服务端渲染）
- 原生 JavaScript（AJAX请求）
- CSS3（现代化UI）
- 响应式设计（支持移动端）

**特点**：
- ✅ SEO友好（服务端渲染）
- ✅ 无需构建工具
- ✅ 加载速度快
- ✅ 易于维护

### 2. Web服务层
**Nginx 角色**：
```
用户请求 → Nginx处理
  ├─ 静态文件请求 → 直接返回 (高性能)
  ├─ 媒体文件请求 → 直接返回
  └─ 动态请求 → 转发到Gunicorn
```

**优化配置**：
- Gzip压缩：减少传输大小
- 缓存控制：静态文件30天缓存
- 请求限流：防止DDoS攻击
- SSL/TLS：HTTPS加密传输

### 3. 应用服务层
**Gunicorn 工作模式**：
```
Master Process (主进程)
  ├─ Worker 1 (工作进程)
  ├─ Worker 2
  ├─ Worker 3
  └─ Worker N
```

**进程数量计算**：
```
workers = CPU核心数 × 2 + 1

示例：
- 1核CPU → 3个workers
- 2核CPU → 5个workers
- 4核CPU → 9个workers
```

### 4. Django应用层

#### 4.1 accounts 模块（用户管理）
```python
账户功能流程：
注册 → 验证 → 创建用户 → 自动登录
登录 → 认证 → 创建会话 → 跳转首页
API调用 → JWT认证 → 返回Token → 后续请求携带Token
```

**数据模型**：
- User（Django内置）：用户基础信息
- Profile（可扩展）：用户扩展信息

**API端点**：
- POST `/api/auth/register/` - 注册
- POST `/api/auth/login/` - 登录（返回JWT）
- POST `/api/auth/logout/` - 登出
- GET `/api/auth/profile/` - 获取个人信息
- PUT `/api/auth/profile/` - 更新个人信息

#### 4.2 llm_service 模块（AI聊天）
```python
聊天流程：
用户输入 → 验证权限（支持游客）→ 保存用户消息（登录用户）
  ↓
调用 LangChain 服务
  ↓
LLM API调用（OpenAI/OpenRouter）
  │
  ├─ 如果有图片 → 调用 GPT-4o Vision（微表情分析）
  ├─ 根据宠物类型 → 加载对应System Prompt
  └─ 添加聊天历史 → 上下文理解
  ↓
返回AI响应 → 保存AI消息（登录用户）→ 返回客户端
```

**数据模型**：
- ChatMessage：聊天消息记录
  - user：关联用户（登录用户）
  - session_id：会话ID
  - role：user/assistant
  - content：消息内容
  - created_at：创建时间

- LLMConfig：LLM配置
  - name：配置名称
  - provider：提供商
  - model_name：模型名称
  - api_key：API密钥
  - temperature：温度参数
  - max_tokens：最大令牌数

**API端点**：
- POST `/api/llm/chat/` - 发送消息（支持游客）
- GET `/api/llm/messages/` - 获取历史（需登录）
- GET `/api/llm/sessions/` - 获取会话列表（需登录）
- DELETE `/api/llm/sessions/{id}/` - 删除会话（需登录）
- GET `/api/llm/statistics/` - 聊天统计（需登录）

### 5. 数据持久化层

**数据库选择**：
```
开发环境：SQLite（轻量、零配置）
  ↓
生产环境（小型）：SQLite（日访问 < 100K）
  ↓
生产环境（中型）：MySQL（日访问 100K-1M）
  ↓
生产环境（大型）：PostgreSQL（日访问 > 1M）
```

**数据存储策略**：
- 用户数据：实时写入数据库
- 聊天记录：异步批量写入（可选）
- 静态文件：文件系统 / CDN
- 媒体文件：文件系统 / 对象存储

### 6. 外部服务集成

#### 6.1 LLM API 服务
```
支持的提供商：
├─ OpenAI（官方）
├─ OpenRouter（聚合）
├─ Azure OpenAI（企业）
├─ Anthropic（Claude）
└─ 本地模型（Ollama）
```

#### 6.2 情绪识别服务
```
DeepFace + GPT-4o Vision 双引擎：
用户上传照片
  ↓
GPT-4o Vision 分析
  ├─ 检测人脸存在
  ├─ 微表情分析
  ├─ 情绪识别（7种基础情绪）
  └─ 物品识别
  ↓
整合结果返回
```

---

## 🚀 部署架构

### 1Panel 部署方案

```
┌──────────────────────────────────────────────────────┐
│                    1Panel 控制面板                    │
│  ┌────────────────┐  ┌────────────────┐            │
│  │  网站管理      │  │  应用商店      │            │
│  │  • Nginx配置   │  │  • Python 3.11 │            │
│  │  • SSL证书     │  │  • MySQL/Pg    │            │
│  │  • 反向代理    │  │  • Redis       │            │
│  └────────────────┘  └────────────────┘            │
│                                                      │
│  ┌────────────────┐  ┌────────────────┐            │
│  │  进程守护      │  │  文件管理      │            │
│  │  • Gunicorn    │  │  • 上传/下载   │            │
│  │  • 自动重启    │  │  • 在线编辑    │            │
│  └────────────────┘  └────────────────┘            │
│                                                      │
│  ┌────────────────┐  ┌────────────────┐            │
│  │  数据库管理    │  │  监控告警      │            │
│  │  • 备份还原    │  │  • 资源监控    │            │
│  │  • 在线管理    │  │  • 日志查看    │            │
│  └────────────────┘  └────────────────┘            │
└──────────────────────────────────────────────────────┘
```

### 部署目录结构

```
/opt/django_llm/                    # 项目根目录
├── venv/                           # Python虚拟环境
├── mysite/                         # Django项目配置
│   ├── settings.py                 # 基础配置
│   ├── settings_production.py      # 生产环境配置
│   ├── urls.py                     # URL路由
│   └── wsgi.py                     # WSGI入口
├── accounts/                       # 用户管理应用
├── llm_service/                    # LLM服务应用
├── staticfiles/                    # 收集的静态文件
├── media/                          # 用户上传文件
├── logs/                           # 日志文件
│   ├── django.log                  # Django日志
│   ├── gunicorn_access.log         # Gunicorn访问日志
│   ├── gunicorn_error.log          # Gunicorn错误日志
│   ├── nginx_access.log            # Nginx访问日志
│   └── nginx_error.log             # Nginx错误日志
├── db.sqlite3                      # 数据库文件
├── .env                            # 环境变量
├── requirements.txt                # 依赖清单
├── gunicorn_config.py              # Gunicorn配置
└── backup.sh                       # 备份脚本
```

---

## 🔐 安全架构

### 多层安全防护

```
第1层：网络层
├─ 防火墙（UFW/iptables）
├─ DDoS防护
└─ IP黑白名单

第2层：传输层
├─ SSL/TLS加密（HTTPS）
├─ HTTP/2协议
└─ 证书自动续期

第3层：应用层
├─ CSRF保护
├─ XSS防护
├─ SQL注入防护（ORM）
├─ 请求限流
└─ 点击劫持防护

第4层：认证层
├─ JWT Token认证
├─ Session管理
├─ 密码加密（PBKDF2）
└─ 权限控制（@login_required）

第5层：数据层
├─ 数据库加密
├─ 敏感信息脱敏
├─ 定期备份
└─ 访问审计
```

### 安全配置清单

```python
# settings_production.py

# 1. 调试模式关闭
DEBUG = False

# 2. 密钥安全
SECRET_KEY = os.environ.get('DJANGO_SECRET_KEY')

# 3. 域名白名单
ALLOWED_HOSTS = ['yourdomain.com', 'www.yourdomain.com']

# 4. HTTPS强制
SECURE_SSL_REDIRECT = True
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True

# 5. 安全头部
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
X_FRAME_OPTIONS = 'DENY'
```

---

## 📈 性能优化方案

### 1. 数据库优化
```python
# 连接池
CONN_MAX_AGE = 600

# 索引优化
class ChatMessage(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE, db_index=True)
    session_id = models.CharField(max_length=100, db_index=True)
    created_at = models.DateTimeField(auto_now_add=True, db_index=True)

# 查询优化
messages = ChatMessage.objects.select_related('user').filter(...)
```

### 2. 缓存策略
```python
# Redis缓存（可选）
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/1',
    }
}

# 视图缓存
from django.views.decorators.cache import cache_page

@cache_page(60 * 15)  # 缓存15分钟
def llm_service_list(request):
    ...
```

### 3. 静态文件优化
```nginx
# Nginx配置
location /static/ {
    alias /opt/django_llm/staticfiles/;
    expires 30d;                    # 缓存30天
    add_header Cache-Control "public, immutable";
    gzip_static on;                 # 使用预压缩文件
}
```

### 4. Gunicorn优化
```python
# gunicorn_config.py
workers = multiprocessing.cpu_count() * 2 + 1  # 工作进程数
threads = 2                                    # 每个进程的线程数
max_requests = 1000                            # 请求后重启（防止内存泄漏）
timeout = 120                                  # 请求超时
preload_app = True                             # 预加载应用
```

### 5. 异步任务（可选）
```python
# 使用Celery处理耗时任务
from celery import shared_task

@shared_task
def process_llm_request(user_id, message):
    # 异步处理LLM请求
    # 避免阻塞Web请求
    ...
```

---

## 📊 监控和运维

### 日志体系

```
日志分类：
├── 应用日志（Django）
│   ├── django.log          # 一般日志
│   └── django_error.log    # 错误日志
├── Web服务日志（Gunicorn）
│   ├── gunicorn_access.log # 访问日志
│   └── gunicorn_error.log  # 错误日志
├── 代理日志（Nginx）
│   ├── nginx_access.log    # 访问日志
│   └── nginx_error.log     # 错误日志
└── 系统日志（Systemd）
    └── journalctl -u django_llm
```

### 监控指标

```
系统指标：
├── CPU使用率
├── 内存使用率
├── 磁盘使用率
└── 网络流量

应用指标：
├── 请求响应时间
├── QPS（每秒查询数）
├── 错误率
└── 在线用户数

业务指标：
├── 用户注册数
├── 聊天消息数
├── API调用成功率
└── LLM响应时间
```

### 告警策略

```
级别1：紧急（立即处理）
├── 服务宕机
├── 数据库连接失败
└── 磁盘空间不足（>95%）

级别2：重要（1小时内处理）
├── 错误率激增（>5%）
├── 响应时间过长（>5s）
└── CPU使用率持续高位（>90%）

级别3：警告（24小时内处理）
├── 内存使用率偏高（>80%）
├── 磁盘空间紧张（>85%）
└── 备份失败
```

---

## 🔄 CI/CD 流程（建议）

### 自动化部署流程

```
开发环境                生产环境
   │                       │
   ├─ 1. 本地开发          │
   │    git commit         │
   │                       │
   ├─ 2. 推送代码          │
   │    git push           │
   │                       │
   ├─ 3. 自动测试          │
   │    pytest            │
   │                       │
   ├─ 4. 代码审查          │
   │    Code Review        │
   │                       │
   ├─ 5. 合并主分支        │
   │    git merge          │
   │                       │
   └─────────────┬─────────┘
                 │
                 ↓
           6. 自动部署
                 │
        ┌────────┴────────┐
        │                 │
        ↓                 ↓
    拉取代码          安装依赖
        │                 │
        └────────┬────────┘
                 │
                 ↓
            数据库迁移
                 │
                 ↓
            收集静态文件
                 │
                 ↓
            重启服务
                 │
                 ↓
            健康检查
                 │
          ┌──────┴──────┐
          │             │
        成功          失败
          │             │
          ↓             ↓
      通知成功      自动回滚
```

---

## 💰 成本估算

### 服务器配置方案

| 规模 | 配置 | 并发 | 费用/月 | 适用场景 |
|------|------|------|---------|----------|
| 入门 | 1核2G | 50 | ¥50-100 | 个人项目/测试 |
| 基础 | 2核4G | 200 | ¥150-300 | 小型应用 |
| 标准 | 4核8G | 1000 | ¥400-800 | 中型应用 |
| 专业 | 8核16G | 5000 | ¥1000+ | 大型应用 |

### API 调用成本（OpenAI GPT-4o）

```
假设条件：
- 每次对话：~500 tokens
- GPT-4o价格：$2.5 / 1M input tokens, $10 / 1M output tokens
- 平均每次对话成本：~$0.003

预估成本：
- 1000次对话/月  ≈ $3
- 10000次对话/月 ≈ $30
- 100000次对话/月 ≈ $300
```

### 总体成本（中小型项目）

```
月度成本：
├── 服务器：¥200
├── API调用：¥100-300
├── 域名：¥5-50
├── SSL证书：¥0（Let's Encrypt免费）
├── CDN（可选）：¥50-200
└── 总计：¥355-750/月
```

---

## 🎯 最佳实践总结

### 开发阶段
✅ 使用虚拟环境隔离依赖
✅ 遵循 Django 命名规范
✅ 编写详细的代码注释
✅ 提交前进行代码检查（pylint）
✅ 编写单元测试

### 部署阶段
✅ 使用自动化部署脚本
✅ 配置环境变量存储敏感信息
✅ 启用 HTTPS 加密传输
✅ 配置防火墙和安全组
✅ 设置日志轮转和备份

### 运维阶段
✅ 定期检查日志
✅ 监控系统资源使用
✅ 定期备份数据库
✅ 及时更新依赖包
✅ 定期安全审计

---

## 📚 相关文档索引

### 核心文档
1. [README.md](README.md) - 项目说明和快速开始
2. [项目说明.md](项目说明.md) - 详细的项目介绍
3. [1Panel部署指南.md](1Panel部署指南.md) - 完整的部署教程

### 部署脚本
4. [deploy_scripts/quick_deploy.sh](deploy_scripts/quick_deploy.sh) - 自动部署脚本
5. [deploy_scripts/production_settings.py](deploy_scripts/production_settings.py) - 生产配置
6. [deploy_scripts/nginx_config_template.conf](deploy_scripts/nginx_config_template.conf) - Nginx配置

### 功能文档
7. [Django学习总结与最佳实践.md](Django学习总结与最佳实践.md)
8. [情绪识别功能说明.md](情绪识别功能说明.md)
9. [宠物类型聊天功能说明.md](宠物类型聊天功能说明.md)

---

## 🤝 技术支持

### 遇到问题？

1. **查看日志**
   ```bash
   tail -f /opt/django_llm/logs/gunicorn_error.log
   ```

2. **检查服务状态**
   ```bash
   sudo systemctl status django_llm
   ```

3. **查阅文档**
   - Django官方文档：https://docs.djangoproject.com/
   - 1Panel文档：https://1panel.cn/docs/

4. **社区支持**
   - GitHub Issues
   - Django中文社区
   - 1Panel用户论坛

---

**更新时间**：2025-10-27  
**文档版本**：v1.0  
**维护者**：Django LLM项目组

---

**祝您部署成功！** 🎉

