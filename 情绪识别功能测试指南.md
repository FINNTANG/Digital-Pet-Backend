# 摄像头情绪识别功能 - 快速测试指南

## 前置条件检查

### 1. 确认依赖已安装
```bash
pip install -r requirements.txt
```

必需的包：
- ✅ Django 5.2.7
- ✅ djangorestframework 3.15.2
- ✅ langchain 1.0.1
- ✅ langchain-openai 1.0.0
- ✅ openai 2.6.0

### 2. 配置LLM服务

进入Django Admin后台：`http://localhost:8000/admin/`

**添加LLM配置**：
- **配置名称**: OpenAI情绪识别
- **提供商**: openai
- **模型名称**: `gpt-4o-mini`（必须支持多模态）
- **API密钥**: 你的OpenAI API Key（或兼容服务的Key）
- **API基础URL**: （可选）如使用第三方代理
- **是否启用**: ✅ 勾选

保存后确认配置已激活。

### 3. 启动开发服务器
```bash
python manage.py runserver
```

## 功能测试步骤

### 测试1：基础摄像头功能

1. **打开聊天页面**
   - 访问 `http://localhost:8000/llm/chat/`
   - 确保已登录

2. **开启摄像头**
   - 点击"🎥 开启摄像头"按钮
   - 浏览器弹出权限请求 → 点击"允许"
   - ✅ 应看到摄像头实时预览（240px宽度）

3. **拍照**
   - 对着镜头做出明显表情（如开心笑脸😊）
   - 点击"📸 拍照识别"
   - ✅ 应看到：
     - 右侧出现照片缩略图
     - 显示"✅ 照片已捕获，将在发送消息时分析情绪"
     - 控制台输出照片大小（应在20-50KB）

4. **关闭摄像头**
   - 点击"⏹️ 关闭"
   - ✅ 预览区域隐藏，摄像头指示灯熄灭

### 测试2：情绪识别 + 聊天集成

1. **准备情绪场景**
   - 重新开启摄像头
   - 做出**开心表情**（笑容）→ 拍照
   - 输入消息："你好"
   - 点击"发送"

2. **检查响应**
   - ✅ AI正常回复
   - ✅ 情绪结果区域显示：`😊 检测到情绪: happy (置信度: 85%)`
   - ✅ AI的回复风格应该更轻松/积极

3. **测试不同情绪**

   | 表情 | 预期识别 | 测试消息 |
   |------|---------|----------|
   | 😊 微笑 | happy | "今天过得怎么样？" |
   | 😢 皱眉 | sad | "我有点难过" |
   | 😐 面无表情 | neutral | "在吗？" |
   | 😠 皱眉瞪眼 | angry | "很烦" |

### 测试3：无照片情况

1. **不拍照直接发送**
   - 关闭摄像头
   - 输入消息："你好"
   - 点击"发送"
   - ✅ 应正常聊天，无情绪识别结果

2. **清除照片后发送**
   - 拍照后点击"🗑️ 清除照片"
   - 发送消息
   - ✅ 应正常聊天，无情绪识别

### 测试4：宠物人格 + 情绪联合

1. **选择宠物 + 情绪**
   - 选择"灵灵（狐狸）"
   - 拍照（开心表情）
   - 发送："你有什么建议吗？"
   - ✅ 应收到狐狸风格 + 贴合开心情绪的回复

2. **切换宠物测试**
   - 选择"小默（狗狗）"
   - 拍照（悲伤表情）
   - 发送："我有点累"
   - ✅ 应收到狗狗风格 + 安慰性的回复

## 控制台检查

### 前端控制台（F12）

**正常日志**：
```
照片已捕获，数据大小: 35.24 KB
包含情绪识别照片
```

**错误排查**：
- `NotAllowedError`: 用户拒绝摄像头权限 → 提示用户允许
- `NotFoundError`: 设备无摄像头 → 降级为纯文本
- `NotReadableError`: 摄像头被占用 → 关闭其他应用

### 后端日志（Terminal）

**正常日志**：
```
[情绪识别] 检测到: happy (置信度: 0.87)
```

**错误排查**：
- `⚠️ LLM服务未配置` → 检查Admin配置
- `情绪识别失败: ...` → 检查API密钥和网络

## 数据库验证

### 确认无图片存储

```bash
python manage.py shell
```

```python
from llm_service.models import ChatMessage

# 检查最近的消息
messages = ChatMessage.objects.all()[:5]
for msg in messages:
    print(f"角色: {msg.role}, 内容长度: {len(msg.content)}, 内容: {msg.content[:50]}...")

# ✅ 应该只看到文本内容，没有Base64图片数据
```

## REST API测试

使用Postman或curl：

```bash
# 获取access token（先登录）
curl -X POST http://localhost:8000/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"testpass123"}'

# 发送带图片的聊天请求
curl -X POST http://localhost:8000/api/llm/chat/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "message": "你好",
    "session_id": "test-session",
    "pet_type": "fox",
    "image_data": "data:image/jpeg;base64,/9j/4AAQ..."
  }'
```

**预期响应**：
```json
{
  "status": "success",
  "message": "消息发送成功",
  "data": {
    "user_message": "你好",
    "ai_response": "*耳朵抖了抖*... 哦？你看起来心情不错嘛～",
    "session_id": "test-session",
    "detected_emotion": "happy",
    "emotion_confidence": 0.87,
    "result": true,
    "options": ["...", "...", "..."],
    "health": 82,
    "mood": 88
  }
}
```

## 性能测试

### 响应时间基准

| 操作 | 预期时间 |
|------|---------|
| 开启摄像头 | < 1秒 |
| 拍照压缩 | < 0.5秒 |
| 情绪识别API | 1-3秒 |
| 主对话LLM | 2-5秒 |
| **总计（带情绪）** | 3-8秒 |
| **总计（无情绪）** | 2-5秒 |

### 压缩效果

- **原始视频帧**: 640x480 → 约300-500KB
- **压缩后JPEG**: 320xH, Q=0.7 → 约20-50KB
- **压缩率**: 约90%

## 兼容性测试矩阵

| 浏览器 | 版本 | 摄像头 | 拍照 | 情绪识别 | 备注 |
|--------|------|--------|------|----------|------|
| Chrome | 120+ | ✅ | ✅ | ✅ | 推荐 |
| Edge | 120+ | ✅ | ✅ | ✅ | 推荐 |
| Firefox | 121+ | ✅ | ✅ | ✅ | 推荐 |
| Safari (Mac) | 16+ | ✅ | ✅ | ✅ | 需HTTPS或localhost |
| Safari (iOS) | 14+ | ✅ | ✅ | ✅ | 前置摄像头 |
| IE 11 | - | ❌ | ❌ | ❌ | 不支持 |

## 常见问题

### Q: 情绪识别总是返回"unknown"
**A**: 
1. 检查Admin中的model_name是否为 `gpt-4o-mini` 或 `gpt-4o`
2. 确认API密钥有效且有余额
3. 拍照时确保光线充足，面部清晰

### Q: 摄像头无法开启
**A**:
1. 检查浏览器权限设置（地址栏左侧图标）
2. 确认其他应用未占用摄像头
3. 本地开发必须使用 `localhost` 或 HTTPS

### Q: 照片太大被拒绝
**A**:
1. 检查压缩配置（目标320px, Q=0.7）
2. 前端控制台查看实际大小
3. 后端限制为500KB，正常压缩应远小于此

### Q: AI回复未反映情绪
**A**:
1. 检查后端日志确认情绪已识别
2. 置信度过低时（<0.5）可能影响不明显
3. 某些宠物人格本身就较中性

## 成功标准

- ✅ 摄像头正常开启/关闭
- ✅ 照片压缩至20-50KB
- ✅ 情绪识别准确率 >70%（开心、悲伤）
- ✅ 不拍照时正常聊天
- ✅ 数据库无图片存储
- ✅ 响应时间<10秒
- ✅ 无内存泄漏（关闭摄像头后释放）

## 压力测试（可选）

```python
# 连续10次带图片的请求
import requests
import time

for i in range(10):
    start = time.time()
    response = requests.post(
        'http://localhost:8000/api/llm/chat/',
        headers={'Authorization': 'Bearer YOUR_TOKEN'},
        json={
            'message': f'测试消息 {i}',
            'image_data': 'data:image/jpeg;base64,...'
        }
    )
    print(f"请求 {i}: {response.status_code}, 耗时: {time.time()-start:.2f}s")
```

## 下一步

功能正常后：
1. 部署到测试环境
2. 配置生产环境的HTTPS
3. 监控API调用成本
4. 收集用户反馈
5. 考虑本地识别方案（降低成本）

---
**测试完成时间**: 预计30-45分钟  
**最后更新**: 2025-10-23
