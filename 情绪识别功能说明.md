# 摄像头情绪识别功能说明

## 功能概述

本功能允许用户通过网页摄像头拍照，系统会使用多模态LLM（OpenAI gpt-4o-mini）分析用户的面部表情，识别情绪状态，并让AI根据用户的情绪调整回复风格。

## 实现架构

### 前端 (chat.html)
- **摄像头控制**: 使用 `navigator.mediaDevices.getUserMedia` 调用摄像头
- **图片压缩**: 拍照后压缩至320px宽度，JPEG质量0.7，约20-50KB
- **数据传输**: 以Base64 data URL格式随消息一起发送
- **隐私提示**: 明确告知用户照片仅用于即时分析，不保存

### 后端序列化器 (serializers.py)
- **新增字段**: `ChatRequestSerializer.image_data`（可选）
- **数据验证**: 
  - 格式校验（data:image/开头）
  - 大小限制（<500KB Base64编码）

### 视图层 (views.py & api_views.py)
- **传统视图**: `views.send_message()` 接收并透传 `image_data`
- **REST API**: `LLMViewSet.chat()` 通过序列化器接收并传递

### 服务层 (services.py)
- **情绪识别**: `_analyze_emotion_with_llm(image_data)` 
  - 使用 OpenAI gpt-4o-mini 多模态模型
  - 识别7种基础情绪：neutral, happy, sad, angry, surprise, fear, disgust
  - 返回情绪类型和置信度（0.0-1.0）
  
- **上下文注入**: 将情绪结果以额外的 SystemMessage 注入对话
  - AI根据用户情绪调整回复风格
  - 保持现有JSON输出格式和宠物人格
  
- **数据返回**: 在响应JSON中添加
  - `detected_emotion`: 识别到的情绪类型
  - `emotion_confidence`: 置信度分数

## 隐私与安全保护

### 1. 用户知情同意
- 前端明确显示"照片仅用于即时情绪分析，不会保存到服务器"
- 用户需主动点击"开启摄像头"和"拍照识别"

### 2. 数据最小化
- **前端压缩**: 320px宽度，JPEG Q=0.7
- **分辨率限制**: 多模态API使用"low"细节等级
- **大小限制**: 后端拒绝>500KB的数据

### 3. 不落盘存储
- **前端**: Base64数据仅存在内存变量中
- **后端**: `image_data` 仅作为函数参数传递，不写入数据库
- **ChatMessage模型**: 不存储图片字段，仅保存文本消息
- **日志**: 关键路径不记录图片内容

### 4. 传输安全
- 建议生产环境使用HTTPS
- CSRF保护已启用

### 5. 错误处理
- 情绪识别失败不影响主聊天流程
- 返回 `{"detected_emotion": "unknown", "confidence": 0.0}`

## 支持的情绪类型

| 英文标识 | 中文说明 | Emoji |
|---------|---------|-------|
| neutral | 平静/中性 | 😐 |
| happy | 开心/快乐 | 😊 |
| sad | 悲伤/难过 | 😢 |
| angry | 生气/愤怒 | 😠 |
| surprise | 惊讶 | 😮 |
| fear | 恐惧/害怕 | 😨 |
| disgust | 厌恶 | 🤢 |
| unknown | 无法识别 | ❓ |

## 兼容性与回退

### 浏览器兼容性
- ✅ Chrome 53+, Edge 79+, Firefox 36+, Safari 11+
- ❌ IE 11及以下（不支持getUserMedia）

### 回退策略
1. **无摄像头权限**: 显示友好提示，降级为纯文本聊天
2. **多模态API失败**: 返回unknown，不影响聊天
3. **LangChain未安装**: 提示安装依赖
4. **API密钥未配置**: 提示配置API密钥

## 使用流程

### 用户端
1. 打开聊天页面
2. 点击"🎥 开启摄像头"（浏览器弹出权限请求）
3. 对着摄像头调整表情
4. 点击"📸 拍照识别"
5. 看到预览和"✅ 照片已捕获"提示
6. 输入消息并发送
7. AI回复会参考识别到的情绪

### 管理员端
1. 在Admin后台配置LLM（使用OpenAI兼容API）
2. 确保model_name支持多模态（如gpt-4o-mini, gpt-4o）
3. 配置api_key和api_base（如使用第三方代理）

## 成本估算

使用OpenAI gpt-4o-mini：
- 图片处理（low detail）：约 $0.0016 / 张
- 月1000次使用：约 $1.60
- 与主对话的token成本独立

## 测试建议

### 功能测试
- [ ] 摄像头正常开启和关闭
- [ ] 拍照压缩到合理大小（<50KB）
- [ ] 不拍照时正常聊天
- [ ] 拍照后正常聊天并收到情绪结果
- [ ] 各种情绪识别准确性（happy, sad, angry等）

### 安全测试
- [ ] 超大图片被拒绝（>500KB）
- [ ] 非图片数据被拒绝
- [ ] 数据库中无图片数据
- [ ] 日志中无Base64内容

### 兼容性测试
- [ ] Chrome/Edge最新版
- [ ] Firefox最新版
- [ ] Safari (Mac/iOS)
- [ ] 拒绝摄像头权限的降级处理
- [ ] API超时/失败的回退

## 未来优化方向

1. **本地识别**: 集成 `fer` 或 `mediapipe` 实现离线识别
2. **情绪趋势**: 记录会话内的情绪变化曲线（需征得同意）
3. **细粒度控制**: 用户可选择是否启用情绪识别
4. **更多模态**: 语音语调、文本情感联合分析
5. **个性化阈值**: 针对不同用户调整置信度阈值

## 故障排查

### 摄像头无法开启
- 检查浏览器权限设置
- 确认设备有摄像头且未被占用
- 检查是否使用HTTPS（localhost除外）

### 情绪识别返回unknown
- 检查API密钥是否正确
- 确认model_name支持视觉（gpt-4o系列）
- 检查照片质量（光线、角度）
- 查看后端日志的错误信息

### 前端显示异常
- 打开浏览器控制台查看JavaScript错误
- 检查网络请求是否成功
- 确认返回数据包含detected_emotion字段

## 文档更新日期
2025-10-23
